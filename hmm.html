<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  
  <style>
    /* --- THEME VARIABLES --- */
    :root {
      --bg-app: #f8fafc;        
      --bg-surface: #ffffff;
      --bg-hover: #f1f5f9;        
      --primary: #2563eb;        
      --primary-dark: #1e40af;
      --text-main: #0f172a;        
      --text-sec: #64748b;        
      --text-inv: #ffffff;        
      --border: #cbd5e1;            
      --border-strong: #94a3b8;
      --header-bg: #1e293b;        
        
      /* Status Palette */
      --st-move-bg: #dcfce7; --st-move-txt: #14532d; --st-move-bd: #86efac;
      --st-pu-bg: #cffafe;   --st-pu-txt: #164e63;   --st-pu-bd: #67e8f9;
      --st-del-bg: #e0e7ff;  --st-del-txt: #3730a3;  --st-del-bd: #a5b4fc;
      --st-warn-bg: #fef3c7; --st-warn-txt: #78350f; --st-warn-bd: #fcd34d;
      --st-crit-bg: #fee2e2; --st-crit-txt: #7f1d1d; --st-crit-bd: #fca5a5;
      --st-idle-bg: #f1f5f9; --st-idle-txt: #475569; --st-idle-bd: #cbd5e1;
      --st-res-bg: #f3e8ff;  --st-res-txt: #581c87;  --st-res-bd: #d8b4fe;
      --st-dock-bg: #ccfbf1; --st-dock-txt: #134e4a; --st-dock-bd: #5eead4;
      --st-wait-bg: #fef9c3; --st-wait-txt: #713f12; --st-wait-bd: #fde047;
      --st-stop-bg: #ffedd5; --st-stop-txt: #7c2d12; --st-stop-bd: #fed7aa;

      --highlight-color: #fef08a; /* Bright Yellow for Light Mode */
      --prebook-color: #2563eb;
    }

    /* --- DARK MODE OVERRIDES --- */
    [data-theme="dark"] {
      --bg-app: #0f172a; --bg-surface: #1e293b; --bg-hover: #334155;
      --primary: #3b82f6; --primary-dark: #60a5fa;
      --text-main: #f1f5f9; --text-sec: #94a3b8; --text-inv: #0f172a;
      --border: #334155; --border-strong: #475569; --header-bg: #020617;

      --st-move-bg: #052e16; --st-move-txt: #86efac; --st-move-bd: #14532d;
      --st-pu-bg: #083344;   --st-pu-txt: #67e8f9;   --st-pu-bd: #164e63;
      --st-del-bg: #1e1b4b;  --st-del-txt: #a5b4fc;  --st-del-bd: #312e81;
      --st-warn-bg: #451a03; --st-warn-txt: #fcd34d; --st-warn-bd: #78350f;
      --st-crit-bg: #450a0a; --st-crit-txt: #fca5a5; --st-crit-bd: #7f1d1d;
      --st-idle-bg: #1e293b; --st-idle-txt: #cbd5e1; --st-idle-bd: #334155;
      --st-res-bg: #3b0764;  --st-res-txt: #d8b4fe;  --st-res-bd: #581c87;
      --st-dock-bg: #042f2e; --st-dock-txt: #5eead4; --st-dock-bd: #134e4a;
      --st-wait-bg: #422006; --st-wait-txt: #fde047; --st-wait-bd: #713f12;
      --st-stop-bg: #431407; --st-stop-txt: #fed7aa; --st-stop-bd: #7c2d12;
      
      --highlight-color: rgba(234, 179, 8, 0.5); /* Gold/Yellow for Dark Mode */
    }

    * { box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }
    .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; padding: 12px; gap: 12px; }

    /* Header */
    .header-bar { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: var(--bg-surface); padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
    .brand-section { display: flex; align-items: center; gap: 10px; }
    h1 { margin: 0; font-size: 1.15rem; font-weight: 700; color: var(--text-main); }
    [data-theme="dark"] h1 { color: #ffffff; }
    .status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 600; text-transform: uppercase; background: var(--st-move-bg); color: var(--st-move-txt); opacity: 0; transition: opacity 0.3s; }
    .status-badge.show { opacity: 1; }
    .actions-section { display: flex; gap: 8px; align-items: center; }

    /* Inputs/Buttons */
    .command-box { position: relative; width: 220px; transition: width 0.3s; }
    .command-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--text-sec); pointer-events: none; }
    .command-input { width: 100%; padding: 8px 12px 8px 34px; border: 1px solid var(--border); border-radius: 6px; font-family: 'Roboto', sans-serif; font-size: 0.85rem; outline: none; background: var(--bg-app); color: var(--text-main); transition: background 0.2s; }
    .command-input:focus { background: var(--bg-surface); border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
    
    button { background: var(--bg-surface); border: 1px solid var(--border); padding: 7px 10px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: var(--text-sec); display: flex; align-items: center; gap: 6px; transition: all 0.1s; }
    button:hover { background: var(--bg-hover); color: var(--text-main); border-color: var(--border-strong); }
    .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary:hover { background: var(--primary-dark); color: white; }
    
    /* Alignment Group */
    .btn-group { display: flex; gap: 1px; background: var(--border); border-radius: 6px; padding: 1px; }
    .btn-group button { border: none; border-radius: 4px; padding: 4px 8px; }
    .btn-group button:hover { background: var(--bg-hover); }

    /* Table */
    .table-container { flex: 1; background: var(--bg-surface); border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); display: flex; flex-direction: column; overflow: hidden; }
    .table-scroll-wrapper { overflow: auto; width: 100%; height: 100%; }
    
    /* Fixed Layout for Column Resizing */
    table { table-layout: fixed; border-collapse: collapse; border-spacing: 0; min-width: 100%; width: max-content; }
    
    /* Header Styling - STICKY FIXED */
    thead th { 
        background: var(--header-bg); color: #ffffff; 
        position: sticky; top: 0; z-index: 50; /* High Z-index */
        padding: 12px 8px; text-align: left; 
        font-size: 0.8rem; font-weight: 700; text-transform: uppercase; 
        border-bottom: 3px solid var(--primary); 
        border-right: 1px solid rgba(255,255,255,0.1); 
        user-select: none; white-space: nowrap; 
        overflow: hidden; text-overflow: ellipsis;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Ensure sticky columns stay UNDER the sticky header */
    td.sticky-col { 
        position: sticky; left: 0; 
        background: var(--bg-surface); 
        z-index: 30; 
        border-right: 2px solid var(--border-strong); 
        font-weight: 700; color: var(--text-main); 
    }
    
    /* The intersection of sticky header and sticky col needs highest Z-index */
    thead th.sticky-col {
        z-index: 60;
    }
    
    /* Column Resizer Handle */
    .col-resizer {
        position: absolute; right: 0; top: 0; bottom: 0;
        width: 5px; cursor: col-resize; z-index: 25;
        transition: background 0.2s;
    }
    .col-resizer:hover, .col-resizer.resizing { background: var(--primary); opacity: 0.7; }

    /* Dragging Styles */
    .dragging-col { opacity: 0.5; background: var(--bg-hover); }
    .drag-over { border-left: 2px solid var(--primary); }
    tr.dragging-row { opacity: 0.4; background: var(--bg-hover); }

    /* --- TD STYLING --- */
    tbody tr { border-bottom: 1px solid var(--border); }
    
    td { 
        padding: 8px; 
        font-size: 0.85rem; color: var(--text-main); 
        border: 1px solid var(--border); 
        /* DEFAULT FONT */
        font-family: 'Roboto', sans-serif; font-weight: 500; 
        white-space: nowrap; height: 40px; vertical-align: middle;
        overflow: hidden; text-overflow: ellipsis; 
        text-align: center; /* Default */
    }

    /* Helper class for monospace cells */
    td.font-mono {
        font-family: 'Roboto Mono', monospace;
    }

    tbody tr:hover td { background-color: var(--bg-hover); }
    
    /* Alignment Classes */
    .align-left { text-align: left !important; justify-content: flex-start !important; }
    .align-center { text-align: center !important; justify-content: center !important; }
    .align-right { text-align: right !important; justify-content: flex-end !important; }

    /* FLASH ANIMATION - YELLOW HIGHLIGHT */
    @keyframes flashHighlight { 
        0% { background-color: var(--highlight-color); } 
        100% { background-color: transparent; } 
    }
    .flash-update { animation: flashHighlight 3s ease-out !important; }

    td input { width: 100%; padding: 4px 6px; margin: 0 -6px; border: 1px solid transparent; border-radius: 4px; font-family: inherit; font-size: 0.85rem; font-weight: 500; outline: none; background: transparent; color: var(--text-main); text-align: inherit; }
    td input:focus { background: var(--bg-surface); border-color: var(--primary); }
    .hidden-col { display: none !important; }

    /* Group Header Row */
    tr.group-header { background-color: var(--bg-hover); cursor: pointer; }
    tr.group-header td { font-family: 'Roboto', sans-serif; font-weight: 700; color: var(--text-main); padding: 10px 12px; border-bottom: 2px solid var(--border); text-align: left; border-top: 1px solid var(--border); }

    /* Badges */
    .badge-wrapper { display: flex; align-items: center; gap: 6px; width:100%; }
    .badge { font-family:'Roboto', sans-serif; display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; line-height: 1; border: 1px solid transparent; text-transform: uppercase; letter-spacing: 0.5px; }
    .st-move { background: var(--st-move-bg); color: var(--st-move-txt); border-color: var(--st-move-bd); }
    .st-pu   { background: var(--st-pu-bg);   color: var(--st-pu-txt);   border-color: var(--st-pu-bd); }
    .st-del  { background: var(--st-del-bg);  color: var(--st-del-txt);  border-color: var(--st-del-bd); }
    .st-warn { background: var(--st-warn-bg); color: var(--st-warn-txt); border-color: var(--st-warn-bd); }
    .st-crit { background: var(--st-crit-bg); color: var(--st-crit-txt); border-color: var(--st-crit-bd); }
    .st-idle { background: var(--st-idle-bg); color: var(--st-idle-txt); border-color: var(--st-idle-bd); }
    .st-res  { background: var(--st-res-bg);  color: var(--st-res-txt);  border-color: var(--st-res-bd); }
    .st-dock { background: var(--st-dock-bg); color: var(--st-dock-txt); border-color: var(--st-dock-bd); }
    .st-wait { background: var(--st-wait-bg); color: var(--st-wait-txt); border-color: var(--st-wait-bd); }
    .st-stop { background: var(--st-stop-bg); color: var(--st-stop-txt); border-color: var(--st-stop-bd); }

    /* ASAP / TEAM - Red BG/White Txt <-> White BG/Red Txt */
    .tag-asap { 
        font-family:'Roboto', sans-serif; 
        display: inline-flex; align-items: center; gap: 4px; 
        font-weight: 800; 
        border: 1px solid #ef4444; 
        padding: 3px 8px; border-radius: 4px; 
        animation: pulse-red-flash 3s infinite linear; 
    }
    
    @keyframes pulse-red-flash { 
        0%, 100% { background-color: #ef4444; color: #ffffff; }
        50% { background-color: #ffffff; color: #ef4444; }
    }
    
    @keyframes pulse-green-flash { 
        0%, 100% { background-color: #15803d; color: #ffffff; }
        50% { background-color: #ffffff; color: #15803d; }
    }

    .prebook-icon { color: var(--prebook-color); font-size: 16px; animation: fadeIn 0.5s; }
    .date-urgent { color: #dc2626; font-weight: 700; background: #fee2e2; padding: 2px 6px; border-radius: 4px; }
    .date-warning { color: #b45309; font-weight: 700; background: #fef3c7; padding: 2px 6px; border-radius: 4px; }
    .live-time { font-family: 'Roboto Mono', monospace; font-weight: 700; color: var(--primary); background: var(--bg-hover); padding: 2px 6px; border-radius: 4px; }

    /* GPS */
    .gps-wrapper { display: flex; align-items: center; gap: 8px; width: 100%; }
    .btn-gps { padding: 2px; width: 28px; height: 28px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-surface); color: var(--text-sec); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; }
    .btn-gps:hover { background: var(--bg-hover); color: var(--primary); border-color: var(--primary); }
    .speed-tag { font-family: 'Roboto Mono', monospace; font-size: 0.8rem; font-weight: 700; color: #0f766e; background: #ccfbf1; padding: 2px 6px; border-radius: 4px; min-width: 50px; text-align: center; }
    .speed-alert { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; } 
    .rotate-icon { animation: spin 1s infinite linear; color: var(--primary); }

    /* Status Picker */
    .status-editor { 
        position: absolute; 
        background: var(--bg-surface); 
        border: 1px solid var(--border); 
        border-radius: 8px; 
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3); 
        z-index: 1000; 
        width: 240px; 
        padding: 10px; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        animation: fadeIn 0.1s ease-out;
        color: var(--text-main);
    }
    .status-search { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; outline: none; font-family: 'Roboto', sans-serif; background: var(--bg-app); color: var(--text-main); }
    .status-search:focus { border-color: var(--primary); }
    .status-grid { display: flex; flex-direction: column; gap: 4px; max-height: 220px; overflow-y: auto; }
    .status-option { padding: 6px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.1s; color: var(--text-main); }
    .status-option:hover { background: var(--bg-hover); }

    /* Header Popup */
    .header-popup { position: fixed; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); padding: 12px; width: 260px; display: none; z-index: 300; flex-direction: column; gap: 8px; color: var(--text-main); }
    .header-popup.active { display: flex; }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(3px); z-index: 200; display: none; justify-content: center; align-items: center; }
    .modal-overlay.active { display: flex; }
    .modal-card { background: var(--bg-surface); width: 380px; border-radius: 10px; padding: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); border: 1px solid var(--border); color: var(--text-main); }
    
    .dropdown-menu { position: absolute; right: 0; top: calc(100% + 5px); background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); width: 240px; padding: 4px; display: none; z-index: 100; }
    .dropdown-menu.show { display: block; }
    .menu-item { padding: 8px; font-size: 0.85rem; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); }
    .menu-item:hover { background: var(--bg-hover); }

    /* TOASTS */
    #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events:none; }
    .toast { pointer-events: auto; background: var(--bg-surface); border: 1px solid var(--border); width: 320px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); padding: 12px; display: flex; gap: 10px; align-items: flex-start; animation: slideIn 0.3s; transition: opacity 0.3s; color: var(--text-main); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .gps-spinning { animation: spin 1s infinite linear; color: var(--primary); }
    .del-view-btn { padding:4px; border-radius:4px; color: var(--text-sec); transition:0.2s; }
    .del-view-btn:hover { background: var(--st-crit-bg); color: var(--st-crit-txt); }

    /* --- DRAG & DROP STOP EDITOR --- */
    .stop-editor {
        position: fixed; /* Fixed to viewport so it stays on screen */
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 10px 40px -5px rgba(0,0,0,0.4);
        z-index: 1000;
        width: 480px;
        padding: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fadeIn 0.1s ease-out;
        font-family: 'Roboto', sans-serif;
        /* Max height constraints */
        max-height: 90vh;
    }
    .stop-header {
        padding: 12px;
        background: var(--bg-hover);
        border-bottom: 1px solid var(--border);
        font-weight: 700;
        font-size: 0.85rem;
        color: var(--text-sec);
        display: flex; justify-content: space-between;
        align-items: center;
        cursor: move;
    }
    .stop-list {
        display: flex; 
        flex-direction: column; 
        max-height: 400px; 
        overflow-y: auto;
        padding: 8px;
        gap: 6px;
    }
    
    /* DRAGGABLE ITEM STYLES */
    .stop-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: var(--bg-app);
        transition: transform 0.1s, box-shadow 0.1s;
    }
    .stop-item.dragging {
        opacity: 0.5;
        background: var(--bg-hover);
        border: 2px dashed var(--primary);
    }
    .stop-item.drag-over {
        border-bottom: 3px solid var(--primary);
        margin-bottom: 3px;
    }
    .stop-item.completed {
        opacity: 0.6;
    }
    .stop-item.completed .stop-input {
        text-decoration: line-through;
        color: var(--text-sec);
    }

    /* CONTROLS */
    .drag-handle {
        cursor: grab;
        color: var(--border-strong);
        display: flex; align-items: center;
    }
    .drag-handle:active { cursor: grabbing; color: var(--primary); }
    
    .stop-checkbox {
        width: 18px; height: 18px;
        cursor: pointer;
        accent-color: var(--primary);
    }
    
    .stop-type-badge {
        font-size: 0.7rem;
        font-weight: 800;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        width: 55px;
        text-align: center;
        letter-spacing: 0.5px;
    }
    .type-pick { background: #dcfce7; color: #14532d; border: 1px solid #86efac; }
    .type-drop { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }

    .stop-marker {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--text-sec);
        width: 15px;
        text-align: right;
        user-select: none;
    }
    
    .stop-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 0.9rem;
        color: var(--text-main);
        outline: none;
        font-family: 'Roboto', sans-serif;
        padding: 4px;
    }
    .stop-input:focus { border-bottom: 2px solid var(--primary); background: var(--bg-surface); }
    
    .btn-remove {
        cursor: pointer; color: var(--text-sec); opacity: 0.5;
        font-size: 20px;
        padding: 4px;
        border-radius: 4px;
    }
    .btn-remove:hover { color: #ef4444; opacity: 1; background: #fee2e2; }
    
    .editor-actions {
        padding: 12px;
        border-top: 1px solid var(--border);
        display: flex; justify-content: space-between;
        background: var(--bg-surface);
    }
    
    /* --- SAMSARA LIVE DROPDOWN --- */
    .live-tracker-window {
        position: absolute;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
        z-index: 1001;
        font-size: 0.8rem;
        width: 220px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        color: var(--text-main);
        animation: fadeIn 0.1s ease-out;
    }
    .tracker-header { font-weight: 700; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 4px; margin-bottom: 4px; }
    .tracker-row { display: flex; justify-content: space-between; }
    .tracker-val { font-family: 'Roboto Mono', monospace; }

    /* --- BETTER TRUCK & ANIMATION --- */
    .loader-wrapper {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--bg-app); 
        z-index: 2000;
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        /* The Background fades out, it does not slide */
        transition: opacity 0.8s ease-out;
    }

    /* Class added when data is ready */
    .loader-wrapper.finish-loading {
        opacity: 0;
        pointer-events: none; /* Allow clicking through while fading */
    }

    .truck-scene {
        position: relative;
        width: 600px; /* Wider for bigger truck */
        height: 250px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
    }

    /* The Truck SVG Container */
    .truck-svg {
        width: 550px; /* Larger Truck */
        height: auto;
        z-index: 10;
        /* 1. Enter Animation */
        animation: driveIn 1s cubic-bezier(0.25, 1, 0.5, 1) forwards,
                   idleBounce 0.6s ease-in-out infinite alternate 1s; /* Start bouncing after entry */
    }

    /* Exit Animation (triggered by JS parent class) */
    .finish-loading .truck-svg {
        animation: driveOut 0.8s ease-in forwards;
    }

    /* The Moving Road (Small piece, not screen width) */
    .road-strip {
        width: 580px;
        height: 8px;
        background: #334155;
        border-radius: 4px;
        margin-top: 2px;
        position: relative;
        overflow: hidden;
        /* Mask to fade edges of the road */
        mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
    }

    .road-lines {
        position: absolute; top: 3px; left: 0;
        width: 200%; height: 2px;
        background: repeating-linear-gradient(90deg, #94a3b8, #94a3b8 20px, transparent 20px, transparent 40px);
        animation: roadScroll 1s linear infinite;
    }

    .loading-text {
        margin-top: 20px;
        font-family: 'Roboto Mono', monospace;
        font-weight: 700; color: var(--text-sec);
        font-size: 0.9rem; letter-spacing: 1px;
        animation: pulseText 1.5s infinite;
    }

    /* Map & Expandable Row */
    .map-row { background: #000; transition: all 0.3s; }
    .map-container { height: 400px; width: 100%; border: none; }
    .btn-track { color: #f59e0b; cursor: pointer; transition: 0.2s; }
    .btn-track:hover { color: #d97706; transform: scale(1.1); }
    
    /* Copy Template Button */
    .btn-copy-template { 
        color: var(--primary); 
        cursor: pointer; 
        padding: 4px; 
        border-radius: 4px; 
        border: 1px solid var(--border);
        background: var(--bg-surface);
        display: inline-flex;
    }
    .btn-copy-template:hover { background: var(--bg-hover); color: var(--primary-dark); }

    /* Idle/Time Tag */
    .idle-tag { font-size: 0.65rem; color: var(--text-sec); font-family: 'Roboto Mono', monospace; margin-left: 4px; }

    /* --- KEYFRAMES --- */
    
    /* 1. Truck fades in from Left */
    @keyframes driveIn {
        0% { opacity: 0; transform: translateX(-150px); }
        100% { opacity: 1; transform: translateX(0); }
    }

    /* 2. Truck idles/bounces in middle */
    @keyframes idleBounce {
        0% { transform: translateY(0); }
        100% { transform: translateY(-2px); }
    }

    /* 3. Truck fades out to Right */
    @keyframes driveOut {
        0% { opacity: 1; transform: translateX(0) scale(1); }
        100% { opacity: 0; transform: translateX(200px) scale(0.95); }
    }

    /* Road moves left to simulate speed */
    @keyframes roadScroll {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }
    
    @keyframes pulseText { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* --- LOAD PARSER MODAL --- */
    .load-modal {
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-surface);
        width: 400px;
        /* Prevent overflow on small screens */
        max-height: 90vh; 
        overflow-y: auto;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        border: 1px solid var(--border);
        z-index: 2000;
        display: none;
        flex-direction: column;
        gap: 15px;
        animation: slideUp 0.2s ease-out;
    }
    .load-modal.active { display: flex; }
    
    .load-modal h3 { margin: 0; font-size: 1.1rem; color: var(--text-main); display:flex; align-items:center; gap:8px; }
    
    .paste-area {
        width: 100%;
        height: 120px;
        background: var(--bg-app);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 10px;
        font-family: 'Roboto Mono', monospace;
        font-size: 0.75rem;
        resize: none;
        outline: none;
        color: var(--text-main);
    }
    .paste-area:focus { border-color: var(--primary); }
    
    .divider-text { 
        text-align: center; font-size: 0.75rem; color: var(--text-sec); 
        position: relative; 
    }
    .divider-text::before, .divider-text::after {
        content: ""; position: absolute; top: 50%; width: 40%; height: 1px; background: var(--border);
    }
    .divider-text::before { left: 0; } .divider-text::after { right: 0; }

    .manual-input-group { display: flex; gap: 8px; }
    
    @keyframes slideUp { from { transform: translate(-50%, -45%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
  
  /* --- MOBILE CARD VIEW STYLES --- */
#mobileCardContainer {
    display: none; /* Hidden on Desktop */
    flex-direction: column;
    gap: 12px;
    padding: 12px;
    overflow-y: auto;
    height: 100%;
}

.m-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.m-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
}

.m-unit-box { font-weight: 800; font-size: 1.2rem; color: var(--primary); font-family: 'Roboto Mono', monospace; }

.m-card-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
}

.m-label { font-size: 0.65rem; color: var(--text-sec); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
.m-value { font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-top: 2px; }

.m-full-width { grid-column: span 3; }

.m-card-actions {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-top: 5px;
}

.m-card-actions button { 
    padding: 10px 5px; 
    font-size: 0.75rem; 
    justify-content: center; 
    background: var(--bg-app);
}

.m-group-header {
    background: var(--bg-hover);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    font-weight: 700;
    color: var(--text-main);
    display: flex; justify-content: space-between; align-items: center;
    border: 1px solid var(--border);
    cursor: pointer;
}
.m-group-body { display: none; flex-direction: column; gap: 12px; }
.m-group-body.open { display: flex; }


/* RESPONSIVE TOGGLE */
@media (max-width: 768px) {
    .table-scroll-wrapper { display: none !important; } /* Hide Desktop Table */
    .app-container { padding: 5px; }
    #mobileCardContainer { display: flex !important; } /* Force show cards */
    .header-bar { padding: 8px; flex-wrap: wrap; gap: 10px; }
    
    /* Responsive Buttons: Hide unwanted buttons on mobile */
    .btn-cols, .btn-views, .btn-refresh { display: none !important; }
    .btn-group { display: none !important; } /* HIDDEN ON MOBILE */
    .btn-new { display: none !important; } /* HIDDEN ON MOBILE */
    
    .brand-section h1 { font-size: 1rem; }
    .brand-section { width: 100%; justify-content: center; order: 1; margin-bottom: 5px; }
    
    /* Reorder Actions for mobile: Search Middle, Group/Theme Right */
    .actions-section { 
        width: 100%; 
        display: flex; 
        order: 2; 
        gap: 8px;
        align-items: center;
    }

    /* Search Bar in Middle (Flex Grow) */
    .command-box { 
        order: 2; 
        flex: 1; /* Takes available middle space */
        min-width: 0;
    }
    
    /* Buttons on Right */
    .btn-group-toggle { order: 3; }
    .btn-theme { order: 4; display: flex !important; }
    
    /* Ensure button text visibility */
    .m-card-actions button { color: var(--text-main); }
}
/* Add this to allow detailed addresses to wrap nicely */
.address-cell {
    white-space: normal !important; 
    font-size: 0.75rem !important; 
    line-height: 1.2;
    max-width: 250px;
}
  </style>
</head>
<body>

<div class="app-container">
  <div class="header-bar">
    <div class="brand-section">
      <span class="material-icons-outlined" style="color:var(--primary)">local_shipping</span>
      <h1>Dispatch Board</h1>
      <span id="saveStatus" class="status-badge">Saved</span>
    </div>
    
    <div class="btn-group mobile-hidden">
        <button onclick="setGlobalAlignment('left')" title="Align Left"><span class="material-icons-outlined" style="font-size:16px">format_align_left</span></button>
        <button onclick="setGlobalAlignment('center')" title="Align Center"><span class="material-icons-outlined" style="font-size:16px">format_align_center</span></button>
        <button onclick="setGlobalAlignment('right')" title="Align Right"><span class="material-icons-outlined" style="font-size:16px">format_align_right</span></button>
    </div>

    <div class="actions-section">
      <div class="command-box">
        <span class="material-icons-outlined command-icon">search</span>
        <input type="text" id="commandInput" class="command-input" placeholder="Search..." onkeyup="handleCommand()">
      </div>
      <button class="btn-group-toggle" onclick="toggleDispatcherGroup()" title="Group by Dispatcher">
        <span class="material-icons-outlined">group_work</span> Group
      </button>
      <button class="btn-cols" onclick="openColumnManager()"><span class="material-icons-outlined">view_column</span> Cols</button>
      <div class="dropdown btn-views" style="position:relative">
        <button onclick="toggleViewsMenu()"><span class="material-icons-outlined">filter_list</span> Views</button>
        <div id="viewsMenu" class="dropdown-menu">
          <div class="menu-item" style="font-weight:600; color:var(--primary)" onclick="openSaveViewModal()">
            <span class="material-icons-outlined" style="font-size:16px;">add</span> Save New View
          </div>
          <hr style="border:0; border-top:1px solid var(--border); margin:4px 0;">
          <div id="savedViewsList"></div>
          <hr style="border:0; border-top:1px solid var(--border); margin:4px 0;">
          <div class="menu-item" style="color:var(--st-crit-txt);" onclick="resetView()">
            <span class="material-icons-outlined" style="font-size:16px;">restart_alt</span> Reset Default
          </div>
        </div>
      </div>
      <button class="btn-theme" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span class="material-icons-outlined" id="themeIcon">dark_mode</span>
      </button>
      <button class="btn-refresh" onclick="reloadData()" title="Refresh"><span class="material-icons-outlined">refresh</span></button>
      <button class="btn-primary btn-new" onclick="addNewRow()"><span class="material-icons-outlined">add</span> New</button>
    </div>
  </div>

  <div class="table-container">
    <div id="loading" class="loader-wrapper">
      <div class="truck-scene">
        <svg class="truck-svg" viewBox="0 0 240 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="10" y="20" width="150" height="60" rx="4" fill="#808080" stroke="#64748b" stroke-width="2"/>
            <rect x="15" y="25" width="140" height="50" rx="2" fill="white" fill-opacity="0.3"/>
            <image href="https://fairandfastlogistics.com/wp-content/uploads/2024/08/fair-and-fast.webp" 
                   x="20" y="25" width="130" height="50" preserveAspectRatio="xMidYMid meet" />
            <rect x="160" y="60" width="10" height="10" fill="#334155"/>
            <path d="M170 80V45C170 42.2386 172.239 40 175 40H200L220 60V80H170Z" fill="#2563eb" stroke="#1e40af" stroke-width="2"/>
            <circle cx="40" cy="85" r="12" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
            <circle cx="70" cy="85" r="12" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
            <circle cx="195" cy="85" r="12" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
        </svg>
        <div class="road-strip"><div class="road-lines"></div></div>
      </div>
      <div class="loading-text">STARTING LOAD BOARD...</div>
    </div>

    <div id="errorMsg" style="padding:40px; text-align:center; color:var(--st-crit-txt); display:none;"></div>
    
    <div class="table-scroll-wrapper">
      <table id="mainTable" style="display:none;">
        <thead id="tHead"></thead>
        <tbody id="tBody"></tbody>
      </table>
    </div>

    <div id="mobileCardContainer"></div>
  </div>
</div>
</div>

<div id="toastContainer"></div>

<div class="modal-overlay" id="genericModal">
  <div class="modal-card">
    <h3 id="modalTitle" style="margin-top:0;">Title</h3>
    <p id="modalText" style="color:var(--text-sec); margin-bottom:20px; line-height:1.5;"></p>
    <input type="text" id="modalInput" class="command-input" style="display:none; margin-bottom:20px;">
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button onclick="closeGenericModal()">Cancel</button>
      <button id="modalConfirmBtn" class="btn-primary">Confirm</button>
    </div>
  </div>
</div>

<div id="headerMenu" class="header-popup">
  <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.75rem; color:var(--text-sec); padding-bottom:4px; border-bottom:1px solid var(--border);">
      <span>ALIGNMENT</span>
  </div>
  <div class="btn-group" style="justify-content:center; margin:4px 0;">
    <button onclick="setColumnAlignment('left')" title="Align Left"><span class="material-icons-outlined" style="font-size:16px">format_align_left</span></button>
    <button onclick="setColumnAlignment('center')" title="Align Center"><span class="material-icons-outlined" style="font-size:16px">format_align_center</span></button>
    <button onclick="setColumnAlignment('right')" title="Align Right"><span class="material-icons-outlined" style="font-size:16px">format_align_right</span></button>
  </div>
  
  <div class="menu-item" onclick="sortColumn('asc')">
    <span class="material-icons-outlined" style="font-size:16px;">arrow_upward</span> Sort Ascending
  </div>
  <div class="menu-item" onclick="sortColumn('desc')">
    <span class="material-icons-outlined" style="font-size:16px;">arrow_downward</span> Sort Descending
  </div>
  <hr style="border:0; border-top:1px solid var(--border); margin:4px 0;">
  <input type="text" id="filterSearch" class="command-input" style="padding:6px; font-size:0.8rem" placeholder="Filter..." onkeyup="filterCheckboxes()">
  <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:var(--primary); margin:4px 0; cursor:pointer;">
    <span onclick="toggleAllFilters(true)">Select All</span>
    <span onclick="toggleAllFilters(false)">Clear</span>
  </div>
  <div id="filterList" style="max-height:150px; overflow-y:auto; padding:4px;"></div>
  <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
    <button style="padding:4px 8px; font-size:0.75rem" onclick="closeHeaderMenu()">Close</button>
    <button class="btn-primary" style="padding:4px 8px; font-size:0.75rem" onclick="applyHeaderFilter()">Apply</button>
  </div>
</div>

<div class="modal-overlay" id="colModalOverlay">
  <div class="modal-card">
    <h3 style="margin-top:0;">Manage Columns</h3>
    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--primary); cursor:pointer; margin-bottom:10px;">
      <span onclick="toggleAllColumns(true)">Show All</span>
      <span onclick="toggleAllColumns(false)">Hide All</span>
    </div>
    <div id="colList" style="max-height:40vh; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:10px; display:grid; grid-template-columns: 1fr 1fr; gap:8px; color:var(--text-main);"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
      <button onclick="closeColumnManager()">Cancel</button>
      <button class="btn-primary" onclick="saveColumnVisibility()">Save</button>
    </div>
  </div>
</div>
<div id="loadParserModal" class="load-modal">
  <h3><span class="material-icons-outlined" style="color:var(--primary)">smart_toy</span> Smart Load Entry</h3>
  
  <div>
    <label style="font-size:0.8rem; font-weight:700; color:var(--text-sec);">PASTE FULL LOAD DETAILS</label>
    <textarea id="loadPasteArea" class="paste-area" placeholder="Paste text from broker email/chat here...
Broker: ABC Logistics
Load# 12345
PU: Dallas TX..."></textarea>
    <button class="btn-primary" style="width:100%; justify-content:center; margin-top:8px;" onclick="processPastedLoad()">
       <span class="material-icons-outlined">auto_fix_high</span> Auto-Fill Load & Stops
    </button>
  </div>

  <div class="divider-text">OR</div>

  <div>
    <label style="font-size:0.8rem; font-weight:700; color:var(--text-sec);">MANUAL LOAD #</label>
    <div class="manual-input-group">
        <input type="text" id="manualLoadInput" class="command-input" placeholder="Type Load # only...">
        <button onclick="saveManualLoad()" style="white-space:nowrap;">Save #</button>
    </div>
  </div>
  
  <div style="text-align:right;">
      <button onclick="closeLoadModal()" style="font-size:0.75rem; padding:4px 8px; border:none; background:transparent; text-decoration:underline;">Cancel</button>
  </div>
</div>
<script>
  // Store the API Key passed from Backend
  const MAPS_API_KEY = "<?= mapsApiKey ?>";
  let tableData = { headers: [], rows: [] }; 
  let viewRows = []; 
  let hiddenCols = [0]; 
  let rowNotes = {};
  let colFilters = {}; 
  
  // -- VIEW STATE --
  let columnOrder = []; 
  let customRowOrder = []; 
  let columnWidths = {}; 
  let columnAlignments = {}; 

  let currentPreset = null;
  let isSaving = false;
  let isEditing = false;
  let editingId = null;
  let syncInterval = null;
  let isGrouped = false; 
  let liveClockInterval = null;
  let speedMonitorInterval = null;
  let liveTrackers = {}; // Store intervals for live dropdowns

  // DnD & Resize Variables
  let dragSrcEl = null;
  let dragType = null; 
  let resizingCol = -1;
  let startX = 0;
  let startWidth = 0;

  const STATUS_OPTS = [
    { label: "Rolling", icon: "local_shipping", class: "st-move" },
    { label: "At PU", icon: "north", class: "st-pu" },
    { label: "At DEL", icon: "south", class: "st-del" },
    { label: "At Dock", icon: "dock", class: "st-dock" },
    { label: "Waiting", icon: "hourglass_empty", class: "st-wait" },
    { label: "Stopped", icon: "pan_tool", class: "st-stop" },
    { label: "Empty", icon: "bedtime", class: "st-idle" },
    { label: "Shop", icon: "build", class: "st-warn" },
    { label: "ASAP", icon: "priority_high", class: "st-crit" },
    { label: "Reserved", icon: "bookmark", class: "st-res" },
    { label: "Completed", icon: "check_circle", class: "st-move" },
    { label: "Cancelled", icon: "block", class: "st-crit" },
    { label: "Ready", icon: "thumb_up", class: "st-wait" }
  ];

  window.onbeforeunload = function() { if (isSaving) return "Saving changes..."; };
  window.onload = () => {
      initTheme();
      loadData();
  };

  function initTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          document.getElementById('themeIcon').innerText = 'light_mode';
      }
  }
  function toggleTheme() {
      const curr = document.documentElement.getAttribute('data-theme');
      if (curr === 'dark') {
          document.documentElement.setAttribute('data-theme', 'light');
          document.getElementById('themeIcon').innerText = 'dark_mode';
          localStorage.setItem('theme', 'light');
      } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          document.getElementById('themeIcon').innerText = 'light_mode';
          localStorage.setItem('theme', 'dark');
      }
  }

  // Close menus on click outside
  document.addEventListener('mousedown', function(e) {
    const menu = document.getElementById('headerMenu');
    const viewsDropdown = document.getElementById('viewsMenu');
    const statusPicker = document.querySelector('.status-editor');
    // Close live trackers if clicking outside
    if (!e.target.closest('.live-tracker-window') && !e.target.closest('.btn-live')) {
        document.querySelectorAll('.live-tracker-window').forEach(el => {
            const id = el.dataset.rowId;
            clearInterval(liveTrackers[id]);
            delete liveTrackers[id];
            el.remove();
        });
    }
    
    if (menu.classList.contains('active') && !menu.contains(e.target) && !e.target.closest('th')) { closeHeaderMenu(); }
    if (viewsDropdown.classList.contains('show') && !viewsDropdown.contains(e.target) && !e.target.closest('.dropdown button')) { viewsDropdown.classList.remove('show'); }
    if (statusPicker && !statusPicker.contains(e.target)) { statusPicker.remove(); isEditing = false; editingId = null; currentEditingCol = null;}
  });

  function loadData() { google.script.run.withSuccessHandler(initTable).withFailureHandler(showError).getData(); }
  
  function reloadData() { 
      const loader = document.getElementById('loading');
      
      // Reset animation state
      loader.classList.remove('finish-loading'); 
      loader.style.display = 'flex'; 
      
      // Hide table
      document.getElementById('mainTable').style.display='none'; 
      
      loadData(); 
  }
  
  function showError(e) { 
      document.getElementById('loading').style.display='none'; 
      const errDiv = document.getElementById('errorMsg');
      errDiv.innerText = "Error: " + e.message;
      errDiv.style.display = 'block';
      showToast("Error: " + e.message, 'error'); 
  }

  function initTable(data) {
    try {
      tableData = data; 
      rowNotes = {};
      if (tableData.notes && tableData.rows) {
          tableData.rows.forEach((row, i) => {
              if (tableData.notes[i]) rowNotes[row[0]] = tableData.notes[i];
          });
      }

      if (columnOrder.length !== tableData.headers.length) {
         const newOrder = [];
         columnOrder.forEach(idx => { if(idx < tableData.headers.length) newOrder.push(idx); });
         for(let i=0; i<tableData.headers.length; i++) {
            if(!newOrder.includes(i)) newOrder.push(i);
         }
         columnOrder = newOrder;
      }
      
      viewRows = [...tableData.rows];
      refreshSavedViewsList(); 
      colFilters = {};
      
      // CRITICAL FIX: Explicitly call render here
      render(); 
      
      if (syncInterval) clearInterval(syncInterval);
      syncInterval = setInterval(silentSync, 5000);
      startLiveClocks();
      startSpeedMonitor();

      const loader = document.getElementById('loading');
      if (loader) {
          loader.classList.add('finish-loading');
          // Show both potential view containers
          document.getElementById('mainTable').style.display = 'table';
          document.getElementById('mobileCardContainer').style.display = window.innerWidth <= 768 ? 'flex' : 'none';
          setTimeout(() => { loader.style.display = 'none'; }, 800);
      }
    } catch (e) { showError(e); }
}

  // --- RESIZING LOGIC ---
  function initResize(e, colIdx) {
      e.stopPropagation(); e.preventDefault();
      resizingCol = colIdx;
      startX = e.pageX;
      const th = e.target.parentElement;
      startWidth = th.offsetWidth;
      document.body.style.cursor = 'col-resize';
      document.addEventListener('mousemove', onResize);
      document.addEventListener('mouseup', stopResize);
  }
  function onResize(e) {
      if (resizingCol === -1) return;
      const diff = e.pageX - startX;
      const newWidth = Math.max(50, startWidth + diff); 
      const th = document.querySelector(`th[data-col="${resizingCol}"]`);
      if(th) th.style.width = newWidth + 'px';
  }
  function stopResize(e) {
      if(resizingCol !== -1) {
          const th = document.querySelector(`th[data-col="${resizingCol}"]`);
          if(th) {
              columnWidths[resizingCol] = th.offsetWidth;
              autoUpdateCurrentView();
          }
      }
      resizingCol = -1;
      document.body.style.cursor = 'default';
      document.removeEventListener('mousemove', onResize);
      document.removeEventListener('mouseup', stopResize);
  }

  // --- ALIGNMENT LOGIC ---
  function setGlobalAlignment(align) {
      tableData.headers.forEach((_, i) => columnAlignments[i] = align);
      render();
      autoUpdateCurrentView();
  }
  function setColumnAlignment(align) {
      if(currentMenuCol > -1) {
          columnAlignments[currentMenuCol] = align;
          render();
          autoUpdateCurrentView();
          closeHeaderMenu();
      }
  }

  // --- AUTOMATED SPEED CHECK ---
  function startSpeedMonitor() {
      if (speedMonitorInterval) clearInterval(speedMonitorInterval);
      speedMonitorInterval = setInterval(runSpeedCheck, 300000); // 5 Minutes
  }

  function runSpeedCheck() {
      if (isEditing) return; 
      const unitColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("unit"));
      const statusColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("status") || h.toLowerCase().includes("sts"));
      const gpsColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("gps/speed"));
      
      if (unitColIdx === -1 || statusColIdx === -1 || gpsColIdx === -1) return;
      
      const targetUnits = []; const idMap = {};
      
      // Keywords to ALLOW updates for (Case Insensitive)
      const allowed = ["rolling", "stopped", "reserved"];

      viewRows.forEach(row => {
          const u = String(row[unitColIdx]).trim();
          const s = String(row[statusColIdx]).toLowerCase();
          
          // Check if status exactly matches or contains allowed keywords
          const isTrackable = allowed.some(keyword => s.includes(keyword));

          if (u && isTrackable) { 
              targetUnits.push(u); 
              idMap[u] = row[0]; 
          }
      });
      
      if (targetUnits.length === 0) return;
      // Triggers backend function
      google.script.run.withSuccessHandler(results => { updateSpeedCells(results, idMap, gpsColIdx); }).getBatchSpeeds(targetUnits);
  }
  function updateSpeedCells(results, idMap, gpsColIdx) {
      for (const [unit, speedVal] of Object.entries(results)) {
          const rowId = idMap[unit];
          const speedStr = speedVal + " mph";
          const r = tableData.rows.find(r => String(r[0]) === rowId);
          if (r) r[gpsColIdx] = speedStr;
          const visualIdx = columnOrder.indexOf(gpsColIdx);
          if (visualIdx > -1) {
              const cell = document.querySelector(`tr[data-id="${rowId}"] td:nth-child(${visualIdx+1})`);
              if (cell) {
                  const tag = cell.querySelector('.speed-tag');
                  if (tag) {
                      tag.innerText = speedStr;
                      if (speedVal < 35) tag.classList.add('speed-alert');
                      else tag.classList.remove('speed-alert');
                  }
              }
          }
      }
      showToast(`Updated speeds for ${Object.keys(results).length} units`, 'info');
  }

  function startLiveClocks() {
      if (liveClockInterval) clearInterval(liveClockInterval);
      liveClockInterval = setInterval(() => {
          const clockCells = document.querySelectorAll('.live-time');
          if(clockCells.length === 0) return;
          const now = new Date();
          clockCells.forEach(cell => {
              const tz = cell.getAttribute('data-timezone');
              if (tz) {
                  try {
                      const timeStr = now.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
                      cell.innerText = timeStr;
                  } catch(e) {}
              }
          });
      }, 1000); 
  }

  let toastQueue = [];
  let isToastShowing = false;
  let currentToastTimeout = null;

  function showToast(message, type='info') { toastQueue.push({ message, type }); if (!isToastShowing) processToastQueue(); }
  function processToastQueue() {
    if (toastQueue.length === 0) { isToastShowing = false; return; }
    isToastShowing = true;
    const { message, type } = toastQueue.shift();
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    let icon = type==='success' ? 'check_circle' : (type==='error' ? 'warning' : 'info');
    let color = type==='success' ? '#10b981' : (type==='error' ? '#ef4444' : '#3b82f6');
    toast.innerHTML = `<span class="material-icons-outlined" style="color:${color}">${icon}</span><div style="flex:1">${message}</div><span class="material-icons-outlined" style="cursor:pointer; font-size:16px; color:var(--text-sec)" onclick="dismissToast(this)">close</span>`;
    toast.onmouseenter = () => clearTimeout(currentToastTimeout);
    toast.onmouseleave = () => startDismissTimer(toast);
    container.appendChild(toast);
    startDismissTimer(toast);
  }
  function startDismissTimer(toast) { currentToastTimeout = setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => { toast.remove(); processToastQueue(); }, 300); }, 3000); }
  window.dismissToast = function(el) { const toast = el.parentElement; clearTimeout(currentToastTimeout); toast.remove(); processToastQueue(); };

  function formatCellHTML(cell, i) {
    const hName = (tableData.headers[i] || "").toLowerCase();
    const isAddress = hName.includes('city') || hName.includes('state') || hName.includes('location') || hName.includes('zip') || hName.includes('address');

    if (typeof cell === 'string') {
        let lower = cell.toLowerCase().trim();
        
        if (['asap', 'urgent', 'hot', 'team', 'STR8', 'straight'].some(k => lower.includes(k))) return `<span class="tag-asap"><i class="material-icons-outlined" style="font-size:14px;">priority_high</i> ${cell}</span>`;

        if (!isAddress) {
            let badgeClass = ''; let icon = '';
            let content = cell.replace(/prebooked/i, '').trim(); 
            let isPrebooked = lower.includes('prebooked');

            if (['dock', 'door', 'loading', 'unloading'].some(k => lower.includes(k))) { badgeClass = 'st-dock'; icon = 'dock'; }
            else if (['shipper', 'at pu', 'picking up'].some(k => lower.includes(k))) { badgeClass = 'st-pu'; icon = 'north'; }
            else if (['receiver', 'at del', 'dropping'].some(k => lower.includes(k))) { badgeClass = 'st-del'; icon = 'south'; }
            else if (['rolling', 'transit', 'covered', 'en route', 'completed'].some(k => lower.includes(k))) { badgeClass = 'st-move'; icon = 'local_shipping'; }
            else if (['waiting', 'detention', 'hold', 'ready'].some(k => lower.includes(k))) { badgeClass = 'st-wait'; icon = 'hourglass_empty'; }
            else if (['shop', 'accident', 'breakdown', 'stopped', 'parked', 'shutdown'].some(k => lower.includes(k))) { badgeClass = lower.includes('shop') ? 'st-warn' : 'st-stop'; icon = lower.includes('shop') ? 'build' : 'pan_tool'; }
            else if (['cancelled'].some(k => lower.includes(k))) { badgeClass = 'st-crit'; icon = 'block'; }
            else if (['reserved'].some(k => lower.includes(k))) { badgeClass = 'st-res'; icon = 'bookmark'; }
            else if (['empty', 'home', 'rest', 'inactive'].some(k => lower.includes(k))) { badgeClass = 'st-idle'; icon = 'bedtime'; }

            if (badgeClass) {
                let align = columnAlignments[i] || 'center';
                let justifyContent = align === 'left' ? 'flex-start' : (align === 'right' ? 'flex-end' : 'center');
                
                let html = `<div class="badge-wrapper" style="justify-content:${justifyContent}"><span class="badge ${badgeClass}"><i class="material-icons-outlined">${icon}</i> ${content}</span>`;
                if (isPrebooked) html += `<i class="material-icons-outlined prebook-icon" title="Unit is Prebooked">event</i>`;
                html += `</div>`;
                return html;
            }
        }
    }
    
    // Date/Time Urgency Logic
    if ((hName.includes('time') && hName.includes('appt')) || (hName.includes('date'))) {
        const dateColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('date') && h.toLowerCase().includes('appt'));
        let compareDate = null;
        
        if (hName.includes('date')) {
             if (typeof cell === 'string' && cell.includes('/')) {
                 const parts = cell.split('/');
                 const today = new Date(); 
                 compareDate = new Date(today.getFullYear(), parseInt(parts[0])-1, parseInt(parts[1]));
             }
        } else if (dateColIdx > -1) {
             // Logic handled in getCellDisplayHTML context
        }

        if (compareDate) {
            const today = new Date(); today.setHours(0,0,0,0);
            const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
            if (compareDate <= today) return `<span class="date-urgent">${cell}</span>`;
            if (compareDate.getTime() === tomorrow.getTime()) return `<span class="date-warning">${cell}</span>`;
        }
    }
    return cell;
  }

  // Helper to fetch live route link
  function getRouteLink(origin, destination) {
      if (!origin || !destination) return "";
      return "https://www.google.com/maps/dir/?api=1&origin=" + encodeURIComponent(origin) + "&destination=" + encodeURIComponent(destination);
  }

  function getCellDisplayHTML(row, colIndex) {
      var hName = (tableData.headers[colIndex] || "").toLowerCase();
      var cellValue = row[colIndex];

      // ---------------------------------------------------------
      // 1. MULTI-STOP LIST DISPLAY (The New Logic)
      // ---------------------------------------------------------
      if (hName.includes('location') && typeof cellValue === 'string' && cellValue.trim().startsWith('[')) {
          try {
              const arr = JSON.parse(cellValue);
              const activeStop = arr.find(s => !s.completed);
              
              if (activeStop) {
                  const total = arr.length;
                  const currentIdx = arr.indexOf(activeStop) + 1;
                  const type = activeStop.type || "STOP"; 
                  
                  let badgeClass = (type === 'PICK') ? 'st-move' : (type === 'DROP' ? 'st-del' : 'st-dock');
                  
                  return `<div style="display:flex; align-items:center; gap:6px;">
                            <span class="badge ${badgeClass}" title="Stop ${currentIdx} of ${total} is a ${type}">${type} ${currentIdx}/${total}</span>
                            <span>${activeStop.address}</span>
                          </div>`;
              } else {
                  return `<div style="display:flex; align-items:center; gap:6px; opacity:0.5;">
                            <span class="badge st-idle">Done</span>
                            <span style="text-decoration:line-through;">${arr[arr.length-1].address}</span>
                          </div>`;
              }
          } catch(e) { 
              return cellValue; 
          }
      }

      // ---------------------------------------------------------
      // 2. GPS / SPEED COLUMN (Updated: No Live Button)
      // ---------------------------------------------------------
      if (hName.includes('gps/speed') || hName.includes('gps speed')) {
          var unitColIdx = tableData.headers.findIndex(function(h) { var t = h.toLowerCase(); return t.includes('unit') || t.includes('truck'); });
          var unitNumber = unitColIdx > -1 ? row[unitColIdx] : '';
          var speedClass = '';
          var numVal = parseInt(String(cellValue).replace(/\D/g, ''));
          
          if (!isNaN(numVal) && numVal < 35) speedClass = 'speed-alert';
          
          var align = columnAlignments[colIndex] || 'center';
          var justifyContent = align === 'left' ? 'flex-start' : (align === 'right' ? 'flex-end' : 'center');

          return `<div class="gps-wrapper" style="justify-content:${justifyContent}">
                    <button class="btn-gps" title="Sync Unit GPS" onclick="triggerSingleSync(event, this, '${unitNumber}', '${row[0]}', ${colIndex})">
                        <span class="material-icons-outlined" style="font-size:16px;">my_location</span>
                    </button>
                    
                    <button class="btn-gps btn-track" title="Show Map" onclick="toggleTrackingMap(event, this, '${row[0]}', '${unitNumber}')">
                         <span class="material-icons-outlined" style="font-size:16px;">map</span>
                    </button>
                    
                    <div style="display:flex; flex-direction:column; align-items:center; line-height:1;">
                        <span class="speed-tag ${speedClass}">${cellValue || "0 mph"}</span>
                        <span class="idle-tag" id="idle-${row[0]}"></span>
                    </div>
                  </div>`;
      }

      // ---------------------------------------------------------
      // 3. MILES OUT (Updated with COPY UPDATE Button)
      // ---------------------------------------------------------
      if (hName.includes('miles') || hName.includes('miles out')) {
          var mapLink = "";
          var notesForRow = rowNotes[row[0]];
          if (notesForRow && notesForRow[colIndex] && notesForRow[colIndex].startsWith("http")) { mapLink = notesForRow[colIndex]; } 
          else {
              var curLocIdx = tableData.headers.findIndex(function(h) { return h.toLowerCase().includes('current') && (h.toLowerCase().includes('loc') || h.toLowerCase().includes('city')); });
              var nextLocIdx = tableData.headers.findIndex(function(h) { return h.toLowerCase().includes('next') && (h.toLowerCase().includes('loc') || h.toLowerCase().includes('city')); });
              if (curLocIdx > -1 && nextLocIdx > -1 && row[curLocIdx] && row[nextLocIdx]) { mapLink = getRouteLink(row[curLocIdx], row[nextLocIdx]); }
          }

          var html = `<div style="display:flex; align-items:center; justify-content:center; gap:6px;">
                        <span>${cellValue || ""}</span>`;
          
          if (mapLink) {
              html += `<a href="${mapLink}" target="_blank" style="text-decoration:none; vertical-align:middle; display:inline-flex;" title="Open Route">
                  <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="#EA4335"><path d="M480-480q33 0 56.5-23.5T560-560q0-33-23.5-56.5T480-640q-33 0-56.5 23.5T400-560q0 33 23.5 56.5T480-480Zm0 294q122-112 181-203.5T720-552q0-109-69.5-178.5T480-800q-101 0-170.5 69.5T240-552q0 71 59 162.5T480-186Zm0 106Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880q127 0 223.5 89T800-552q0 100-79.5 217.5T480-80Zm0-480Z"/></svg>
                  </a>`;
          }
          
          // COPY BUTTON ADDITION
          html += `<button class="btn-copy-template" title="Copy Update Email" onclick="copyUpdateToClipboard('${row[0]}')">
                     <span class="material-icons-outlined" style="font-size:14px;">content_copy</span>
                   </button>`;
          
          html += `</div>`;
          return html;
      }

      // ---------------------------------------------------------
      // 4. DATE & TIME FORMATTING
      // ---------------------------------------------------------
      var strVal = String(cellValue).toLowerCase();
      
      if ((hName.includes('time') || hName.includes('appt')) && (strVal.includes('asap') || strVal.includes('str8') || strVal.includes('team'))) {
           return formatCellHTML(cellValue, colIndex);
      }
      
      if ((hName.includes('time there') || (hName.includes('dest') && hName.includes('time')))) {
          // If the cell contains a TimeZone string (e.g. "America/Chicago")
          if (cellValue && typeof cellValue === 'string' && (cellValue.includes('America') || cellValue.includes('US/'))) {
               try {
                   var now = new Date();
                   // Check if valid timezone by trying to format
                   var timeStr = now.toLocaleTimeString('en-US', { timeZone: cellValue, hour: '2-digit', minute: '2-digit', hour12: false });
                   
                   return `<div style="display:flex; flex-direction:column; align-items:center;">
                             <span class="live-time" data-timezone="${cellValue}">${timeStr}</span>
                             <span style="font-size:0.65rem; color:var(--text-sec); margin-top:2px;">${cellValue.split('/')[1].replace('_',' ')}</span>
                           </div>`;
               } catch(e) { return cellValue; }
          }
      }
      
      if (hName.includes('time') && hName.includes('appt')) {
          var dateColIdx = tableData.headers.findIndex(function(h) { return h.toLowerCase().includes('date') && h.toLowerCase().includes('appt'); });
          if (dateColIdx > -1) {
              var dateStr = row[dateColIdx];
              if (typeof dateStr === 'string' && dateStr.includes('/')) {
                  var today = new Date(); today.setHours(0,0,0,0);
                  var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
                  var parts = dateStr.split('/');
                  var dateVal = new Date(today.getFullYear(), parseInt(parts[0])-1, parseInt(parts[1]));
                  
                  if (!isNaN(dateVal.getTime())) {
                      if (dateVal <= today) return '<span class="date-urgent">' + cellValue + '</span>';
                      else if (dateVal.getTime() === tomorrow.getTime()) return '<span class="date-warning">' + cellValue + '</span>';
                  }
              }
          }
      }

      return formatCellHTML(cellValue, colIndex);
  }

  function triggerSingleSync(e, btn, unitNumber, rowId, colIndex, callback) {
      if (e) e.stopPropagation(); 
      if (!unitNumber) { showToast('No Unit Number found', 'error'); return; }
      
      // Handle icon inside button (Mobile or Desktop)
      let icon = null;
      if (btn) {
        icon = btn.querySelector('.material-icons-outlined');
        if(icon) {
            icon.innerText = 'sync'; icon.classList.add('rotate-icon');
        }
      }
      
      const driverColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("samsara driver"));
      let driverName = ""; if (driverColIdx > -1) { const row = tableData.rows.find(r => String(r[0]) === rowId); if (row) driverName = row[driverColIdx]; }
      
      google.script.run.withSuccessHandler((res) => {
          if(icon) { icon.classList.remove('rotate-icon'); icon.innerText = 'my_location'; }
          
          if (res.error) { 
              showToast(res.error, 'error'); 
          } else {
              // --- DESKTOP UI UPDATE ---
              // Try to update the desktop cell if it exists
              const visualIdx = columnOrder.indexOf(colIndex);
              const desktopCell = document.querySelector(`tr[data-id="${rowId}"] td:nth-child(${visualIdx+1})`);
              
              if(desktopCell) {
                  const speedTag = desktopCell.querySelector('.speed-tag');
                  if (speedTag) { 
                      speedTag.innerText = res.speed; 
                      const numVal = parseInt(res.speed.replace(/\D/g,'')); 
                      if(!isNaN(numVal) && numVal < 35) speedTag.classList.add('speed-alert'); else speedTag.classList.remove('speed-alert'); 
                  }
                  
                  // Store lat/lng on map button
                  const trackBtn = desktopCell.querySelector('.btn-track');
                  if(trackBtn && res.lat && res.lng) {
                      trackBtn.dataset.lat = res.lat;
                      trackBtn.dataset.lng = res.lng;
                      if(trackBtn.dataset.openAfter === "true") {
                          trackBtn.dataset.openAfter = "false";
                          toggleTrackingMap(e, trackBtn, rowId, unitNumber);
                      }
                  }
              }
              
              // --- MOBILE UI UPDATE (Targeting specific IDs) ---
              const mCity = document.getElementById(`m-loc-${rowId}`);
              const mMiles = document.getElementById(`m-miles-${rowId}`);
              const mEta = document.getElementById(`m-eta-${rowId}`);
              const mSyncSpeed = document.getElementById(`sync-speed-${rowId}`);

              if(mCity && res.location) {
                  mCity.innerText = res.location;
                  highlightCell(mCity);
              }
              if(mSyncSpeed && res.speed) {
                  mSyncSpeed.innerText = res.speed;
              }
              
              // Flash Miles/ETA to show sync interaction, even if value doesn't change immediately
              if (mMiles) highlightCell(mMiles);
              if (mEta) highlightCell(mEta);

              // Added checks for miles/eta in case backend returns them directly
              if(mMiles && res.miles) {
                   mMiles.innerText = res.miles;
                   highlightCell(mMiles);
              }
              if(mEta && res.eta) {
                   mEta.innerText = res.eta;
                   highlightCell(mEta);
              }

              // If backend updated tableData, we sync it
              const r = tableData.rows.find(r => String(r[0]) === rowId); 
              if(r) {
                  if (colIndex > -1) r[colIndex] = res.speed;
                  const locColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("current location"));
                  if(locColIdx > -1) r[locColIdx] = res.location;
              }

              showToast(`Synced: ${res.speed}`, 'success');
              
              // Map Callback Execution
              if (callback) callback(res);
          }
      }).withFailureHandler(err => { 
          if(icon) { icon.classList.remove('rotate-icon'); icon.innerText = 'error'; }
          showToast(err.message, 'error'); 
      }).syncSingleUnit(unitNumber, driverName);
  }

  // --- NEW: Global Map Storage & Loader ---
  let activeMaps = {};         
  let activeMapPollers = {}; 
  let activeAnimators = {};  
  let mapMarkers = {}; // Store marker references
  let mapsLoading = false;

  function loadGoogleMaps(callback) {
      if (typeof google !== "undefined" && google.maps) { callback(); return; }
      if (mapsLoading) { setTimeout(() => loadGoogleMaps(callback), 100); return; }
      
      mapsLoading = true;
      window.initMapsCb = () => { mapsLoading = false; callback(); };
      
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${MAPS_API_KEY}&callback=initMapsCb`;
      document.head.appendChild(script);
  }

  function resetMapCamera(rowId, lat, lng) {
      const map = activeMaps[rowId];
      if (map && map.map) {
          map.map.flyTo({ center: [lng, lat], zoom: 15 });
      }
  }

  // Shared Function to Initialize Mapbox Logic
  function initTrackingMap(mapDivId, rowId, unitNumber, lat, lng, destAddr, toggleBtnId) {
    // Cleanup existing
    if (activeMaps[rowId]) {
        if(activeMapPollers[rowId]) clearTimeout(activeMapPollers[rowId]);
        if(activeAnimators[rowId]) cancelAnimationFrame(activeAnimators[rowId]);
        delete activeMaps[rowId];
    }
    
    // Init Mapbox
    mapboxgl.accessToken = MAPS_API_KEY; 
    const map = new mapboxgl.Map({
        container: mapDivId,
        style: 'mapbox://styles/mapbox/satellite-streets-v12',
        center: [lng, lat],
        zoom: 16,
        pitch: 50,
        attributionControl: false
    });
    map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

    const el = document.createElement('div');
    el.className = 'marker-arrow';
    el.style.zIndex = '100'; 
    el.innerHTML = `<svg width="56" height="56" viewBox="0 0 24 24" style="filter: drop-shadow(0px 6px 12px rgba(0,0,0,0.8)); transition: transform 0.2s linear;"><path d="M12 2 L2 22 L12 18 L22 22 Z" fill="#3b82f6" stroke="white" stroke-width="2" stroke-linejoin="round" /></svg>`;
    const carMarker = new mapboxgl.Marker({ element: el }).setLngLat([lng, lat]).addTo(map);
    
    activeMaps[rowId] = { 
        map: map, 
        routeLine: null,
        currentDistance: 0,
        currentSpeed: 0,    
        lastUpdateTime: 0,
        isMoving: false
    };

    let isFollowMode = true; 
    let destCoords = null;

    if (destAddr) {
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(destAddr)}.json?limit=1&access_token=${MAPS_API_KEY}`)
        .then(r => r.json())
        .then(data => {
            if (data.features && data.features.length > 0) {
                destCoords = data.features[0].center;
                const destEl = document.createElement('div');
                destEl.innerHTML = `<span class="material-icons-outlined" style="color:#ef4444; font-size:32px; text-shadow:0 2px 4px black;">flag</span>`;
                new mapboxgl.Marker({ element: destEl, anchor:'bottom-left' }).setLngLat(destCoords).addTo(map);

                fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${lng},${lat};${destCoords[0]},${destCoords[1]}?geometries=geojson&overview=full&steps=true&access_token=${MAPS_API_KEY}`)
                .then(r => r.json())
                .then(routeData => {
                    if (routeData.routes && routeData.routes.length > 0) {
                        const geometry = routeData.routes[0].geometry;
                        if(activeMaps[rowId]) {
                            activeMaps[rowId].routeLine = geometry.coordinates;
                            const snap = RouteUtils.snapToLine([lng, lat], geometry.coordinates);
                            activeMaps[rowId].currentDistance = snap.travelDistance;
                        }
                        const drawRoute = () => {
                             if(map.getSource('route')) return; 
                             map.addSource('route', { type: 'geojson', data: { type: 'Feature', properties: {}, geometry: geometry } });
                             const layers = map.getStyle().layers;
                             let labelLayerId = layers.find(l => l.type === 'symbol' && l.layout['text-field'])?.id;
                             map.addLayer({
                                 id: 'route', type: 'line', source: 'route',
                                 layout: { 'line-join': 'round', 'line-cap': 'round' },
                                 paint: { 'line-color': '#3b82f6', 'line-width': 6, 'line-opacity': 0.8 }
                             }, labelLayerId);
                        };
                        if(map.loaded()) drawRoute(); else map.on('load', drawRoute);
                    }
                });
            }
        });
    }

    // Animation Loop
    let lastFrameTime = performance.now();
    function frame(currentTime) {
        if (!activeMaps[rowId]) return;
        const dt = (currentTime - lastFrameTime) / 1000;
        lastFrameTime = currentTime;
        const state = activeMaps[rowId];

        if (state.isMoving && state.routeLine && state.currentSpeed > 0) {
            state.currentDistance += (state.currentSpeed * dt);
            if (typeof RouteUtils !== 'undefined') {
                const newPos = RouteUtils.getCoordAtDist(state.routeLine, state.currentDistance);
                carMarker.setLngLat(newPos);
                if (isFollowMode) { map.easeTo({ center: newPos, duration: 0, easing: t=>t }); }
                
                const lookAheadDist = state.currentDistance + 20; 
                const nextPos = RouteUtils.getCoordAtDist(state.routeLine, lookAheadDist);
                const dy = nextPos[1] - newPos[1];
                const dx = nextPos[0] - newPos[0];
                const theta = Math.atan2(dy, dx); 
                const deg = (theta * 180 / Math.PI) * -1 + 90; 
                const svg = el.querySelector('svg');
                if(svg) svg.style.transform = `rotate(${deg}deg)`;
            }
        }
        activeAnimators[rowId] = requestAnimationFrame(frame);
    }
    activeAnimators[rowId] = requestAnimationFrame(frame);

    // Polling Loop
    const pollFunction = () => {
        if (!activeMaps[rowId]) return;
        google.script.run.withSuccessHandler(data => {
             if (!activeMaps[rowId]) return;
             if (data.error) {
                 activeMapPollers[rowId] = setTimeout(pollFunction, 5000); 
                 return;
             }
             const speedMph = parseInt(data.speed) || 0;
             const state = activeMaps[rowId];

             // Update UI panels (works for both Desktop and Mobile as long as IDs are unique per row)
             const spdEl = document.getElementById(`panel-speed-${rowId}`);
             if(spdEl) spdEl.innerText = speedMph + " mph";
             const timeEl = document.getElementById(`panel-time-${rowId}`);
             if(timeEl) timeEl.innerText = data.startTime || "Active";

             state.currentSpeed = speedMph * 0.44704;
             state.isMoving = speedMph > 0;

             if (state.routeLine && typeof RouteUtils !== 'undefined') {
                 const gpsSnap = RouteUtils.snapToLine([data.lng, data.lat], state.routeLine);
                 const gpsDist = gpsSnap.travelDistance;
                 const animDist = state.currentDistance;
                 const diff = gpsDist - animDist;
                 if (diff > 50) { state.currentDistance = gpsDist; } 
             }
             activeMapPollers[rowId] = setTimeout(pollFunction, 10000); 
        }).withFailureHandler(err => {
             if (activeMaps[rowId]) activeMapPollers[rowId] = setTimeout(pollFunction, 5000);
        }).getSamsaraLocation(unitNumber);
    };
    pollFunction();

    // Toggle Button Logic
    const toggleBtn = document.getElementById(toggleBtnId);
    if(toggleBtn) {
        toggleBtn.onclick = function() {
            if (!isFollowMode) {
                 isFollowMode = true;
                 this.innerHTML = `<span class="material-icons-outlined">map</span> View Route`;
                 this.style.background = "white"; this.style.color = "#0f172a";
                 map.flyTo({ center: carMarker.getLngLat(), zoom: 16, pitch: 50 });
            } else if (destCoords) {
                 isFollowMode = false;
                 this.innerHTML = `<span class="material-icons-outlined">center_focus_strong</span> Focus Driver`;
                 this.style.background = "#3b82f6"; this.style.color = "white";
                 const pos = carMarker.getLngLat();
                 const bounds = new mapboxgl.LngLatBounds([pos.lng, pos.lat], destCoords);
                 map.fitBounds(bounds, { padding: 100, maxZoom: 14, pitch: 0 });
            }
        };
    }
  }

  // DESKTOP: Toggle Map
  function toggleTrackingMap(e, btn, rowId, unitNumber) {
    e.stopPropagation();
    const tr = btn.closest('tr');
    const nextRow = tr.nextElementSibling;
    
    // Close Logic
    if (nextRow && nextRow.classList.contains('map-row')) {
        nextRow.remove();
        if (activeMapPollers[rowId]) clearTimeout(activeMapPollers[rowId]);
        if (activeAnimators[rowId]) cancelAnimationFrame(activeAnimators[rowId]);
        if (activeMaps[rowId]) delete activeMaps[rowId];
        return;
    }

    let lat = parseFloat(btn.dataset.lat);
    let lng = parseFloat(btn.dataset.lng);

    if (!lat || !lng) {
        showToast("Fetching coordinates...", "info");
        btn.dataset.openAfter = "true";
        const syncBtn = btn.parentElement.querySelector('button[title="Sync Unit GPS"]');
        if(syncBtn) syncBtn.click();
        return;
    }

    let destAddr = "";
    const destColIdx = tableData.headers.findIndex(h => {
        const t = h.toLowerCase();
        return t.includes("next appt") && (t.includes("location") || t.includes("city"));
    });
    if (destColIdx > -1) {
        const raw = tableData.rows.find(r => String(r[0]) === String(rowId))[destColIdx];
        if (String(raw).trim().startsWith("[")) {
             try { 
                 const stops = JSON.parse(raw); 
                 const active = stops.find(s => !s.completed) || stops[stops.length-1];
                 destAddr = active ? active.address : "";
             } catch(e) {}
        } else { destAddr = raw; }
    }

    const mapRow = document.createElement('tr'); mapRow.className = 'map-row';
    const mapTd = document.createElement('td'); 
    mapTd.colSpan = columnOrder.length + 1; 
    mapTd.style.padding = "0"; mapTd.style.height = "auto"; mapTd.style.position = "relative";
    const mapDivId = `map-canvas-${rowId}`;
    const toggleBtnId = `view-toggle-${rowId}`;

    mapTd.innerHTML = `
      <div style="position:relative; width:100%; height:500px; background:#0f172a; display:flex;">
          <div id="${mapDivId}" style="flex:1; height:100%;"></div>
          <div style="position:absolute; bottom:20px; left:20px; width:280px; background:rgba(15, 23, 42, 0.95); border:1px solid #334155; border-radius:8px; padding:15px; color:white; font-size:0.8rem; box-shadow:0 10px 25px -5px rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:50;">
              <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
                  <span style="font-weight:800; color:#94a3b8; font-size:0.75rem; letter-spacing:0.5px;">UNIT ${unitNumber}</span>
                  <div id="status-badge-${rowId}" style="background:#22c55e; color:#052e16; padding:3px 8px; border-radius:4px; font-weight:800; font-size:0.7rem;">LIVE</div>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #334155;">
                   <div>
                       <div style="color:#64748b; font-size:0.7rem; font-weight:600;">SPEED</div>
                       <div id="panel-speed-${rowId}" style="font-family:'Roboto Mono'; font-size:1.4rem; font-weight:700;">--</div>
                   </div>
                   <div>
                       <div style="color:#64748b; font-size:0.7rem; font-weight:600;">STATUS</div>
                       <div id="panel-time-${rowId}" style="font-family:'Roboto Mono'; font-size:0.9rem; font-weight:500; margin-top:4px;">--</div>
                   </div>
              </div>
              <div>
                  <div style="color:#64748b; font-size:0.7rem; font-weight:600; margin-bottom:2px;">DESTINATION</div>
                  <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#60a5fa; font-weight:500;">${destAddr || "Not Assigned"}</div>
              </div>
          </div>
          <div style="position:absolute; top:20px; right:20px; z-index:50;">
              <button id="${toggleBtnId}" class="btn-primary" style="box-shadow:0 4px 6px rgba(0,0,0,0.3); font-weight:700; background:white; color:#0f172a; border:none;">
                  <span class="material-icons-outlined">map</span> View Route
              </button>
          </div>
      </div>`;
    
    mapRow.appendChild(mapTd);
    tr.parentNode.insertBefore(mapRow, tr.nextSibling);

    initTrackingMap(mapDivId, rowId, unitNumber, lat, lng, destAddr, toggleBtnId);
  }

  // MOBILE: Toggle Map
  function toggleMobileMap(e, rowId, unit, btnElement) {
    if(e) e.stopPropagation();
    
    const mapDiv = document.getElementById(`m-map-res-${rowId}`);
    const isVisible = mapDiv.style.display === 'block';
    
    // Close if already open
    if (isVisible) {
        mapDiv.style.display = 'none';
        mapDiv.innerHTML = '';
        if (activeMapPollers[rowId]) clearTimeout(activeMapPollers[rowId]);
        if (activeAnimators[rowId]) cancelAnimationFrame(activeAnimators[rowId]);
        if (activeMaps[rowId]) delete activeMaps[rowId];
        return;
    }

    // Close all other open maps
    document.querySelectorAll('[id^="m-map-res-"]').forEach(d => {
        d.style.display = 'none';
        d.innerHTML = ''; 
    });
    
    // Cleanup active maps for other rows
    Object.keys(activeMaps).forEach(k => {
        if(k !== rowId && activeMaps[k]) {
            if(activeMapPollers[k]) clearTimeout(activeMapPollers[k]);
            if(activeAnimators[k]) cancelAnimationFrame(activeAnimators[k]);
            delete activeMaps[k];
        }
    });

    // OPEN MAP: First SYNC to get coords, then open
    mapDiv.style.display = 'block';
    mapDiv.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-sec); font-family:monospace;">SYNCING GPS...</div>';
    
    // Use triggerSingleSync with callback
    triggerSingleSync(null, btnElement, unit, rowId, -1, (res) => {
        if(res.lat && res.lng) {
             // Create container
             const mapDivId = `m-canvas-inner-${rowId}`;
             const toggleBtnId = `m-view-toggle-${rowId}`;
             
             mapDiv.innerHTML = `
             <div style="position:relative; width:100%; height:100%; background:#000;">
                 <div id="${mapDivId}" style="width:100%; height:100%;"></div>
                 <div style="position:absolute; top:10px; right:10px; z-index:10;">
                    <button id="${toggleBtnId}" style="background:white; border:none; border-radius:4px; padding:6px; font-weight:700; box-shadow:0 2px 4px rgba(0,0,0,0.3);">
                        <span class="material-icons-outlined" style="font-size:16px;">map</span>
                    </button>
                 </div>
                 <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.8); color:white; padding:5px 10px; border-radius:4px; font-size:0.75rem;">
                    <span id="panel-speed-${rowId}">${res.speed}</span>
                 </div>
             </div>`;
             
             // Get Destination
             let destAddr = "";
             const destColIdx = tableData.headers.findIndex(h => {
                const t = h.toLowerCase();
                return t.includes("next appt") && (t.includes("location") || t.includes("city"));
             });
             if (destColIdx > -1) {
                const raw = tableData.rows.find(r => String(r[0]) === String(rowId))[destColIdx];
                if (String(raw).trim().startsWith("[")) {
                     try { 
                         const stops = JSON.parse(raw); 
                         const active = stops.find(s => !s.completed) || stops[stops.length-1];
                         destAddr = active ? active.address : "";
                     } catch(e) {}
                } else { destAddr = raw; }
             }
             
             initTrackingMap(mapDivId, rowId, unit, res.lat, res.lng, destAddr, toggleBtnId);

        } else {
             mapDiv.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sec);">Location unavailable</div>';
        }
    });
  }

  // 3. UPDATED: Copy Template (Strict Column Search)
  function copyUpdateToClipboard(rowId) {
      const r = tableData.rows.find(row => String(row[0]) === rowId);
      if(!r) return;

      const getVal = (searchTerms) => {
          const idx = tableData.headers.findIndex(h => {
              const lower = h.toLowerCase();
              return searchTerms.some(term => lower.includes(term));
          });
          return idx > -1 ? r[idx] : "";
      };

      const load = getVal(["load"]);
      const sts = getVal(["sts", "status"]);
      const currentCity = getVal(["current city", "current loc"]);
      const miles = getVal(["miles"]);
      
      let nextStop = "";
      const cityColIdx = tableData.headers.findIndex(h => {
         const t = h.toLowerCase();
         return (t.includes("next") || t.includes("dest")) && (t.includes("city") || t.includes("state"));
      });

      if (cityColIdx > -1) {
          nextStop = r[cityColIdx];
      }
      
      // Fallback
      if (!nextStop || String(nextStop).trim() === "") {
          nextStop = "the destination"; 
      }

      const htmlContent = `
        Update on the load # ${load}<br><br>
        Status: ${sts}<br>
        CL: ${currentCity}<br>
        ${miles} away from <b>${nextStop}</b><br><br>
        Thank you
      `;
      
      const textContent = `Update on the load # ${load}\n\nStatus: ${sts}\nCL: ${currentCity}\n${miles} away from ${nextStop}\n\nThank you`;

      if (navigator.clipboard && navigator.clipboard.write) {
          const blobHtml = new Blob([htmlContent], { type: "text/html" });
          const blobText = new Blob([textContent], { type: "text/plain" });
          const data = [new ClipboardItem({ ["text/html"]: blobHtml, ["text/plain"]: blobText })];

          navigator.clipboard.write(data).then(() => {
              showToast("Update copied (Bold)!", "success");
          }, (err) => {
              navigator.clipboard.writeText(textContent).then(() => showToast("Update copied (Text only)", "info"));
          });
      } else {
          navigator.clipboard.writeText(textContent).then(() => showToast("Update copied!", "success"));
      }
  }

  function highlightCell(cell) {
      cell.classList.remove('flash-update');
      void cell.offsetWidth; 
      cell.classList.add('flash-update');
  }

  function render() {
    // 1. Desktop Sort Logic
    if (customRowOrder.length > 0 && !isGrouped) {
        viewRows.sort((a,b) => {
            const iA = customRowOrder.indexOf(a[0]); 
            const iB = customRowOrder.indexOf(b[0]);
            return (iA === -1 ? 9999 : iA) - (iB === -1 ? 9999 : iB);
        });
    }

    const unitColIndex = tableData.headers.findIndex(h => { 
        const t = h.toLowerCase(); 
        return t.includes('unit') || t.includes('truck') || t.includes('#'); 
    });

    // --- RENDER DESKTOP TABLE ---
    const thead = document.getElementById('tHead'); 
    const tbody = document.getElementById('tBody');
    
    let hHtml = '<tr>';
    columnOrder.forEach((dataIdx, visualIdx) => {
      let h = tableData.headers[dataIdx]; 
      let classes = []; 
      if (hiddenCols.includes(dataIdx)) classes.push('hidden-col'); 
      if (dataIdx === unitColIndex) classes.push('sticky-col');
      let filterIcon = colFilters[dataIdx] ? `<i class="material-icons-outlined" style="font-size:14px; color:var(--primary); margin-left:4px;">filter_alt</i>` : '';
      let widthStyle = columnWidths[dataIdx] ? `width:${columnWidths[dataIdx]}px;` : '';

      hHtml += `
        <th class="${classes.join(' ')}" style="${widthStyle}" data-col="${dataIdx}" 
            onclick="openHeaderMenu(event, ${dataIdx})" 
            draggable="true" 
            ondragstart="handleDragStart(event, 'col', ${visualIdx})" 
            ondragover="handleDragOver(event)" 
            ondrop="handleDrop(event, 'col', ${visualIdx})">
            <div style="display:flex; align-items:center;">${h} ${filterIcon}</div>
            <div class="col-resizer" onmousedown="initResize(event, ${dataIdx})"></div>
        </th>`;
    });
    thead.innerHTML = hHtml + '<th></th></tr>';

    let bHtml = '';
    
    // Check if searching to disable grouping temporarily
    const searchVal = document.getElementById('commandInput').value;
    const effectiveGrouped = isGrouped && (!searchVal || searchVal.length === 0);

    if (effectiveGrouped) {
        const dispColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('dispatch'));
        const groups = {}; 
        viewRows.forEach(row => { 
            const key = row[dispColIdx] || "Unassigned"; 
            if (!groups[key]) groups[key] = []; 
            groups[key].push(row); 
        });
        Object.keys(groups).sort().forEach(key => {
            // Group Header with Collapse logic (Default Collapsed = style="display:none" on body)
            bHtml += `<tr class="group-header" onclick="toggleGroup(this)">
                        <td colspan="${columnOrder.length + 1}">
                            <span class="material-icons-outlined" style="vertical-align:middle; font-size:16px; margin-right:8px;">expand_more</span>${key} (${groups[key].length})
                        </td>
                      </tr><tbody class="group-body" style="display:none">`;
            groups[key].forEach(row => { bHtml += buildRowHTML(row, unitColIndex); });
            bHtml += `</tbody>`;
        });
    } else { 
        viewRows.forEach(row => { bHtml += buildRowHTML(row, unitColIndex); }); 
    }
    tbody.innerHTML = bHtml;

    // --- RENDER MOBILE CARDS ---
    const mobileContainer = document.getElementById('mobileCardContainer');
    mobileContainer.innerHTML = '';

    // Index Lookup for Mobile Card Labels
    const statusIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('sts') || h.toLowerCase().includes('status'));
    const cityIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('current city'));
    const milesIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('miles'));
    // Dest: Next Appt Location or City
    const destIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('next') && (h.toLowerCase().includes('city') || h.toLowerCase().includes('location')));
    const etaIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('eta'));
    const apptDateIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('next appt') && h.toLowerCase().includes('date'));
    const apptTimeIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('next appt') && h.toLowerCase().includes('time'));
    const speedIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('gps') || h.toLowerCase().includes('speed'));
    const dispColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('dispatch'));

    const renderCard = (row) => {
        const id = row[0];
        const unit = row[unitColIndex];
        const statusHTML = getCellDisplayHTML(row, statusIdx);
        
        // Data Extraction
        const currentCity = row[cityIdx] || '---';
        const miles = row[milesIdx] || '0 mi';
        
        let destRaw = row[destIdx];
        let destination = "---";
        if (destRaw) {
             if (String(destRaw).trim().startsWith("[")) {
                 try {
                     const s = JSON.parse(destRaw);
                     const a = s.find(x => !x.completed);
                     destination = a ? a.address : (s[s.length-1].address);
                 } catch(e) { destination = destRaw; }
             } else { destination = destRaw; }
        }
        
        const eta = row[etaIdx] || '--';
        const date = row[apptDateIdx] || '';
        const time = row[apptTimeIdx] || '';
        const apptFull = (date + ' ' + time).trim() || '---';
        const speed = row[speedIdx] || '';

        const card = document.createElement('div');
        card.className = 'm-card';
        card.innerHTML = `
            <div class="m-card-header">
                <div class="m-unit-box">#${unit}</div>
                <div>${statusHTML}</div>
            </div>
            
            <!-- STACKED LAYOUT -->
            <div style="display:flex; flex-direction:column; gap:12px; margin-top:8px;">
                <!-- Current Location Row -->
                <div>
                    <div class="m-label">Current Location</div>
                    <div class="m-value" id="m-loc-${id}" style="font-size:1rem;">${currentCity}</div>
                </div>

                <!-- Destination Row -->
                <div>
                    <div class="m-label">Destination</div>
                    <div class="m-value" style="font-size:1rem; color:var(--primary);">${destination}</div>
                </div>

                <!-- 3 Column Row: Miles | ETA | Appt -->
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; background:var(--bg-hover); padding:8px; border-radius:6px;">
                    <div style="text-align:center;">
                        <div class="m-label">Miles Out</div>
                        <div class="m-value" id="m-miles-${id}">${miles}</div>
                    </div>
                    <div style="text-align:center; border-left:1px solid var(--border); border-right:1px solid var(--border);">
                        <div class="m-label">ETA</div>
                        <div class="m-value" id="m-eta-${id}">${eta}</div>
                    </div>
                    <div style="text-align:center;">
                        <div class="m-label">Appt</div>
                        <div class="m-value" id="m-appt-${id}">${apptFull}</div>
                    </div>
                </div>
            </div>

            <div id="m-map-res-${id}" style="display:none; height:250px; margin-top:5px; border-radius:8px; overflow:hidden; border:1px solid var(--border);"></div>
            
            <div class="m-card-actions">
                <button onclick="toggleMobileMap(event, '${id}', '${unit}', this)">
                    <span class="material-icons-outlined" style="font-size:16px;">map</span> Map
                </button>
                <button class="btn-primary" onclick="copyUpdateToClipboard('${id}')">
                    <span class="material-icons-outlined" style="font-size:16px;">content_copy</span> Copy
                </button>
                <button onclick="triggerSingleSync(event, this, '${unit}', '${id}', ${statusIdx})">
                    <span class="material-icons-outlined" style="font-size:16px;">sync</span> Sync <span id="sync-speed-${id}" style="margin-left:4px; font-weight:700;">${speed}</span>
                </button>
            </div>
        `;
        return card;
    };

    if (effectiveGrouped && dispColIdx > -1) {
        const groups = {}; 
        viewRows.forEach(row => { 
            const key = row[dispColIdx] || "Unassigned"; 
            if (!groups[key]) groups[key] = []; 
            groups[key].push(row); 
        });
        
        Object.keys(groups).sort().forEach(key => {
            const gHeader = document.createElement('div');
            gHeader.className = 'm-group-header';
            gHeader.innerHTML = `<span>${key} (${groups[key].length})</span> <span class="material-icons-outlined">expand_more</span>`;
            gHeader.onclick = function() { 
                this.nextElementSibling.classList.toggle('open'); 
                const icon = this.querySelector('.material-icons-outlined');
                icon.innerText = this.nextElementSibling.classList.contains('open') ? 'expand_less' : 'expand_more';
            };
            
            const gBody = document.createElement('div');
            gBody.className = 'm-group-body';
            
            groups[key].forEach(row => {
                gBody.appendChild(renderCard(row));
            });
            
            mobileContainer.appendChild(gHeader);
            mobileContainer.appendChild(gBody);
        });
    } else {
        viewRows.forEach(row => {
            mobileContainer.appendChild(renderCard(row));
        });
    }
}

  function toggleGroup(header) {
      const body = header.nextElementSibling;
      if (body) {
          const isHidden = body.style.display === 'none';
          body.style.display = isHidden ? 'table-row-group' : 'none';
          const icon = header.querySelector('.material-icons-outlined');
          if(icon) icon.innerText = isHidden ? 'expand_less' : 'expand_more';
      }
  }

  function buildRowHTML(row, unitColIndex) {
      let html = `<tr data-id="${row[0]}" draggable="true" ondragstart="handleDragStart(event, 'row', '${row[0]}')" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'row', '${row[0]}')">`;
      columnOrder.forEach((dataIdx, visualIdx) => {
        let cell = row[dataIdx]; let classes = []; 
        if (hiddenCols.includes(dataIdx)) classes.push('hidden-col'); 
        if (dataIdx === unitColIndex) classes.push('sticky-col');
        
        const align = columnAlignments[dataIdx] || 'center';
        classes.push('align-' + align);

        const hName = (tableData.headers[dataIdx]||"").toLowerCase();
        if(hName.includes('location') || hName.includes('city') || hName.includes('address')) {
            classes.push('font-mono');
            classes.push('address-cell'); // Add this class
        }

        const displayCell = getCellDisplayHTML(row, dataIdx); 
        const type = hName.includes('time') ? 'text' : 'text';
        
        if (visualIdx === 0) html += `<td class="${classes.join(' ')}" style="cursor:grab;">${displayCell}</td>`;
        else html += `<td class="${classes.join(' ')}" style="cursor:pointer;" onclick="editCell(this, ${dataIdx}, '${type}')">${displayCell}</td>`;
      });
      html += `<td><span class="material-icons-outlined" style="cursor:pointer; color:var(--text-sec); font-size:16px;" onclick="deleteItem('${row[0]}')">close</span></td></tr>`;
      return html;
  }

  function handleDragStart(e, type, indexOrId) { if(resizingCol !== -1) { e.preventDefault(); return; } dragSrcEl = e.target; dragType = type; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', indexOrId); e.target.style.opacity = '0.4'; }
  function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; }
  function handleDrop(e, type, targetIndexOrId) {
    if (e.stopPropagation) e.stopPropagation(); if (dragSrcEl) dragSrcEl.style.opacity = '1';
    if (dragType !== type) return false; 
    const source = e.dataTransfer.getData('text/plain');
    if (type === 'col') {
        const srcIdx = parseInt(source); const tgtIdx = parseInt(targetIndexOrId);
        if (srcIdx !== tgtIdx) { const item = columnOrder.splice(srcIdx, 1)[0]; columnOrder.splice(tgtIdx, 0, item); render(); autoUpdateCurrentView(); }
    } else if (type === 'row') {
        const srcId = source; const tgtId = targetIndexOrId;
        if (srcId !== tgtId) {
            const srcRowIdx = viewRows.findIndex(r => r[0] === srcId); const tgtRowIdx = viewRows.findIndex(r => r[0] === tgtId);
            if (srcRowIdx > -1 && tgtRowIdx > -1) { const item = viewRows.splice(srcRowIdx, 1)[0]; viewRows.splice(tgtRowIdx, 0, item); customRowOrder = viewRows.map(r => r[0]); render(); autoUpdateCurrentView(); }
        }
    }
    return false;
  }

  function toggleDispatcherGroup() { isGrouped = !isGrouped; render(); }

  function sortColumn(dir) {
      const colIdx = currentMenuCol; const hName = tableData.headers[colIdx].toLowerCase();
      const isTimeSort = hName.includes('time') && hName.includes('appt');
      const dateColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes('date') && h.toLowerCase().includes('appt'));
      customRowOrder = []; 
      viewRows.sort((a,b) => {
          let vA = a[colIdx], vB = b[colIdx];
          if (isTimeSort && dateColIdx > -1) { const pA = parseDateTime(a[dateColIdx], vA); const pB = parseDateTime(b[dateColIdx], vB); return dir === 'asc' ? pA - pB : pB - pA; }
          return dir === 'asc' ? (vA < vB ? -1 : 1) : (vA > vB ? -1 : 1);
      });
      closeHeaderMenu(); render();
  }
  function parseDateTime(dateStr, timeStr) {
      if (!dateStr) return new Date(8640000000000000).getTime(); 
      const today = new Date(); const parts = dateStr.split('/');
      let d = new Date(today.getFullYear(), parseInt(parts[0])-1, parseInt(parts[1]));
      if (timeStr && timeStr.includes(':')) { const tParts = timeStr.split(':'); d.setHours(parseInt(tParts[0]), parseInt(tParts[1])); }
      return d.getTime();
  }

let isSyncing = false; // Prevents overlapping requests

function silentSync() { 
    if (isSaving || isEditing || dragSrcEl || resizingCol !== -1 || isSyncing) return; 
    
    isSyncing = true;
    google.script.run
        .withSuccessHandler((newData) => {
            mergeData(newData);
            isSyncing = false;
        })
        .withFailureHandler(() => {
            isSyncing = false; 
        })
        .getData(); 
}    
  function mergeData(newData) {
    if (newData.headers.length > tableData.headers.length) { 
        for(let i=tableData.headers.length; i<newData.headers.length; i++) { 
            if(!columnOrder.includes(i)) columnOrder.push(i); 
        } 
    }
    tableData.headers = newData.headers;
    const unitColIdx = tableData.headers.findIndex(h => { const t = h.toLowerCase(); return t.includes('unit') || t.includes('truck'); });
    
    let changesFound = false;
    let newRowAdded = false;

    newData.rows.forEach(newRow => {
      const id = String(newRow[0]); 
      const oldIdx = tableData.rows.findIndex(r => String(r[0]) === id);
      
      if (oldIdx === -1) { 
          tableData.rows.push(newRow); 
          if(customRowOrder.length > 0) customRowOrder.push(id); 
          newRowAdded = true;
      } 
      else {
        const oldRow = tableData.rows[oldIdx];
        newRow.forEach((newVal, cIdx) => {
           if (String(newVal) !== String(oldRow[cIdx])) {
             if (isEditing && editingId === id && currentEditingCol === cIdx) {
                 return;
             }

             tableData.rows[oldIdx][cIdx] = newVal;
             changesFound = true;
             
             if (!isEditing) {
                // Update Desktop
                const visualIdx = columnOrder.indexOf(cIdx);
                if (visualIdx > -1) {
                    const rowEl = document.querySelector(`tr[data-id="${id}"]`);
                    if (rowEl) {
                        const cell = rowEl.querySelector(`td:nth-child(${visualIdx+1})`);
                        if(cell) { 
                            requestAnimationFrame(() => {
                                if (document.body.contains(cell)) {
                                    cell.innerHTML = getCellDisplayHTML(newRow, cIdx); 
                                    highlightCell(cell); 
                                }
                            });
                        }
                    }
                }
                
                // Update Mobile
                // Note: We only update specific tracked fields here to keep it light
                const hName = (tableData.headers[cIdx]||"").toLowerCase();
                if (hName.includes("current city")) {
                      const mCity = document.getElementById(`m-loc-${id}`);
                      if(mCity) { mCity.innerText = newVal; highlightCell(mCity); }
                } else if (hName.includes("miles")) {
                      const mMiles = document.getElementById(`m-miles-${id}`);
                      if(mMiles) { mMiles.innerText = newVal; highlightCell(mMiles); }
                } else if (hName.includes("eta")) {
                      const mEta = document.getElementById(`m-eta-${id}`);
                      if(mEta) { mEta.innerText = newVal; highlightCell(mEta); }
                }
             }
             
             const isRowVisible = viewRows.some(r => String(r[0]) === id); 
             const isColVisible = !hiddenCols.includes(cIdx);
             if (isRowVisible && isColVisible) {
                 const uNum = unitColIdx > -1 ? newRow[unitColIdx] : "ID "+id;
                 const colName = tableData.headers[cIdx];
                 if(String(newVal).trim() !== String(oldRow[cIdx]).trim()) {
                    showToast(`Unit ${uNum} [${colName}]: ${newVal}`, 'info');
                 }
             }
           }
        });
      }
    });
    
    viewRows = viewRows.map(vRow => { const fresh = tableData.rows.find(r => r[0] === vRow[0]); return fresh || vRow; });
    
    if(newRowAdded && !isEditing && !dragSrcEl && resizingCol === -1) {
        render();
    }
  }

  let currentEditingCol = null;
  
  function editCell(td, colIndex, type) {
    if (isEditing) return; 
    var rowId = td.parentElement.getAttribute('data-id') || td.id.split('-')[2]; // Fallback for mobile id check
    
    // For mobile cards where td doesn't exist directly
    if (!rowId && td.classList.contains('m-value')) {
        rowId = td.id.split('-')[2];
    }
    
    // Fallback if no ID found in ID attribute (e.g. wrapper div click)
    if (!rowId) {
        // Traverse up to find m-card and verify logic if needed, but the onclick handlers are specific
        // For Destination/Appt in grid
        const card = td.closest('.m-card');
        if (card) {
            // Find sync button ID inside card to get row ID
            const btn = card.querySelector('[id^="sync-speed-"]');
            if (btn) rowId = btn.id.split('-')[2];
        }
    }

    var headerName = (tableData.headers[colIndex] || "").toLowerCase();

    // --- 1. LOAD # PARSER INTERCEPT ---
    if (headerName.includes('load #') || headerName === 'load') {
        openLoadModal(rowId, colIndex);
        return;
    }    
    // READ ONLY COLUMNS
    if (headerName.includes('gps/speed') || headerName.includes('gps speed')) return;
    if (headerName.includes('miles') || headerName.includes('miles out')) return; 

    // STATUS PICKER INTERCEPT
    if (headerName.includes('sts') || headerName.includes('status')) { 
        openStatusPicker(td, rowId, colIndex); 
        return; 
    }

    // --- MULTI-STOP EDITOR INTERCEPT (UPDATED) ---
    if (headerName.includes('next appt') && (headerName.includes('location') || headerName.includes('city') || headerName.includes('state') || headerName.includes('zip'))) {
        
        const locIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("next appt location"));
        
        if (locIdx > -1) {
            let dataTd = td;
            
            openStopEditor(td, rowId, locIdx, dataTd); 
            return;
        }
    }
    // ----------------------------------------
    
    var originalVal = td.innerText.replace('event','').trim(); 
    isEditing = true; editingId = rowId; currentEditingCol = colIndex;
    var input = document.createElement('input'); input.type = type; input.value = originalVal;
    
    var align = columnAlignments[colIndex] || 'center';
    input.style.textAlign = align;

    td.innerHTML = ''; td.appendChild(input); input.focus();
    var finish = function() { var val = input.value; saveValue(rowId, colIndex, val, td, originalVal); };
    input.onblur = finish; input.onkeydown = function(e) { if(e.key === 'Enter') input.blur(); };
  }

  function openStatusPicker(td, rowId, colIndex) {
      if(isEditing) return; isEditing = true; editingId = rowId;
      const currentVal = td.innerText.replace('event','').trim(); const isPrebooked = currentVal.toLowerCase().includes('prebooked');
      const picker = document.createElement('div'); picker.className = 'status-editor';
      picker.innerHTML = `<input type="text" class="status-search" placeholder="Type to filter..." autofocus><label class="status-toggle"><span>Prebooked?</span><input type="checkbox" id="prebookToggle" ${isPrebooked ? 'checked' : ''}></label><div class="status-grid"></div>`;
      const grid = picker.querySelector('.status-grid');
      const renderOptions = (filterText = "") => {
          grid.innerHTML = ""; const f = filterText.toLowerCase();
          STATUS_OPTS.forEach(opt => {
              if(opt.label.toLowerCase().includes(f)) {
                  const btn = document.createElement('div'); btn.className = 'status-option'; btn.innerHTML = `<span class="badge ${opt.class}"><i class="material-icons-outlined">${opt.icon}</i> ${opt.label}</span>`;
                  btn.onclick = (e) => { 
                      e.stopPropagation(); const prebooked = document.getElementById('prebookToggle').checked; 
                      let finalVal = opt.label; if (prebooked) finalVal += " Prebooked"; 
                      picker.remove(); saveValue(rowId, colIndex, finalVal, td, currentVal); 
                      if (['empty', 'ready'].some(s => finalVal.toLowerCase().includes(s))) {
                          showToast("Clearing trip details...", 'info');
                          google.script.run.withSuccessHandler((res) => {
                              if(res.success && res.updates) {
                                  const r = tableData.rows.find(row => String(row[0]) === rowId);
                                  for (const [idx, val] of Object.entries(res.updates)) {
                                      if(r) r[idx] = val;
                                      const visualIdx = columnOrder.indexOf(parseInt(idx));
                                      if (visualIdx > -1) { const cell = document.querySelector(`tr[data-id="${rowId}"] td:nth-child(${visualIdx+1})`); if(cell) { cell.innerHTML = ""; highlightCell(cell); } }
                                  }
                                  showToast("Trip details cleared", 'success');
                              }
                          }).clearTripDetails(rowId);
                      }
                  };
                  grid.appendChild(btn);
              }
          });
      };
      renderOptions(); 
      const searchInput = picker.querySelector('.status-search'); searchInput.onkeyup = (e) => renderOptions(e.target.value);
      document.body.appendChild(picker);
      
      const rect = td.getBoundingClientRect(); 
      const pickerHeight = 280; 
      let topPos = rect.bottom + window.scrollY; 
      let leftPos = rect.left;
      if (rect.bottom + pickerHeight > window.innerHeight) { topPos = (rect.top + window.scrollY) - picker.offsetHeight - 5; }
      
      picker.style.top = topPos + 'px'; 
      picker.style.left = leftPos + 'px';
      
      searchInput.focus();
  }

  function saveValue(rowId, colIndex, val, td, originalVal) {
      isEditing = false; editingId = null; currentEditingCol = null;
      
      const r = tableData.rows.find(r => String(r[0]) === rowId); 
      if(r) r[colIndex] = val;
      td.innerHTML = getCellDisplayHTML(r, colIndex); 
      
      if (val !== originalVal) {
        showStatus(true);
        
        google.script.run
          .withSuccessHandler((res) => {
             showStatus(false);
             if (res && res.updates) {
                const r = tableData.rows.find(r => String(r[0]) === rowId);
                if (r) {
                   Object.keys(res.updates).forEach(updColIdx => {
                      const newVal = res.updates[updColIdx];
                      const numericColIdx = parseInt(updColIdx);
                      r[numericColIdx] = newVal;
                      const visualIdx = columnOrder.indexOf(numericColIdx);
                      if (visualIdx > -1) {
                         const cellToUpdate = document.querySelector(`tr[data-id="${rowId}"] td:nth-child(${visualIdx + 1})`);
                         if (cellToUpdate) {
                            cellToUpdate.innerHTML = getCellDisplayHTML(r, numericColIdx);
                            highlightCell(cellToUpdate); 
                         }
                      }
                   });
                }
             }

          })
          .withFailureHandler((e)=>{ 
             showToast(e.message,'error'); 
             td.innerHTML=getCellDisplayHTML(r, colIndex); 
          })
          .updateSingleCell(rowId, colIndex, val);
      }
  }

  function openStopEditor(anchorTd, rowId, locColIndex, saveTd = null) {
      if(isEditing) return; isEditing = true; editingId = rowId;
      
      const finalSaveTd = saveTd || anchorTd;
      const row = tableData.rows.find(r => String(r[0]) === String(rowId));
      let rawVal = row ? row[locColIndex] : "";
      
      let stops = [];
      try {
          if (rawVal && String(rawVal).trim().startsWith("[")) {
              stops = JSON.parse(rawVal);
              stops = stops.map(s => ({
                  address: s.address||(typeof s==='string'?s:""), 
                  completed: s.completed||false, 
                  type: s.type||'PICK',
                  date: s.date || "",
                  time: s.time || ""
              }));
          } else if (rawVal) {
              stops = [{ address: rawVal, completed: false, type: 'PICK', date:"", time:"" }];
          }
      } catch(e) { stops = [{ address: rawVal, completed: false, type: 'PICK', date:"", time:"" }]; }
      if(stops.length === 0) stops = [{ address: "", completed: false, type: 'PICK', date:"", time:"" }];

      const editor = document.createElement('div'); editor.className = 'stop-editor';
      // Widen the editor slightly to fit date/time inputs
      editor.style.width = "480px"; 

      const header = document.createElement('div'); header.className = 'stop-header';
      header.innerHTML = `<span>TRIP STOPS</span> <span style="font-size:10px; color:var(--primary);">DRAG HANDLES (::) TO REORDER</span>`;
      editor.appendChild(header);

      const listContainer = document.createElement('div'); 
      listContainer.className = 'stop-list';

      let dragSrcIndex = -1;

      function renderStops() {
          listContainer.innerHTML = '';
          stops.forEach((stop, index) => {
              const item = document.createElement('div'); 
              item.className = `stop-item ${stop.completed ? 'completed' : ''}`;
              item.style.flexWrap = "wrap"; // Allow wrapping for small inputs
              item.setAttribute('draggable', 'true');
              
              // 1. Top Row: Handle, Type, Address, Delete
              const topRow = document.createElement('div');
              topRow.style.display="flex"; topRow.style.alignItems="center"; topRow.style.width="100%"; topRow.style.gap="6px";

              const handle = document.createElement('span'); handle.className = 'material-icons-outlined drag-handle'; handle.innerText = 'drag_indicator';
              const chk = document.createElement('input'); chk.type = "checkbox"; chk.className = "stop-checkbox"; chk.checked = stop.completed;
              chk.onclick = (e) => { e.stopPropagation(); stop.completed = chk.checked; item.classList.toggle('completed', stop.completed); };

              const typeBadge = document.createElement('span');
              const isPick = (stop.type || 'PICK') === 'PICK';
              typeBadge.className = `stop-type-badge ${isPick ? 'type-pick' : 'type-drop'}`;
              typeBadge.innerText = isPick ? 'PICK' : 'DROP';
              typeBadge.onclick = (e) => { e.preventDefault(); e.stopPropagation(); stop.type = isPick ? 'DROP' : 'PICK'; renderStops(); };

              const inp = document.createElement('input'); inp.className = 'stop-input'; inp.value = stop.address || "";
              inp.placeholder = "Address...";
              inp.onclick = (e) => e.stopPropagation();
              inp.oninput = (e) => { stop.address = e.target.value; };
              
              const delBtn = document.createElement('span'); delBtn.className = 'material-icons-outlined btn-remove'; delBtn.innerText = 'close';
              delBtn.onclick = (e) => { e.stopPropagation(); stops.splice(index, 1); renderStops(); };

              topRow.append(handle, chk, typeBadge, inp, delBtn);

              // 2. Bottom Row: Date & Time Inputs
              const botRow = document.createElement('div');
              botRow.style.display="flex"; botRow.style.gap="8px"; botRow.style.paddingLeft="30px"; botRow.style.width="100%"; botRow.style.marginTop="4px";
              
              // Date Input
              const dateInp = document.createElement('input'); 
              dateInp.type = "text"; 
              dateInp.className = 'stop-input'; 
              dateInp.style.fontSize="0.8rem"; dateInp.style.flex="0 0 100px";
              dateInp.placeholder = "MM/DD";
              dateInp.value = stop.date || "";
              dateInp.oninput = (e) => { stop.date = e.target.value; };
              dateInp.onclick = (e) => e.stopPropagation();

              // Time Input
              const timeInp = document.createElement('input'); 
              timeInp.type = "text"; 
              timeInp.className = 'stop-input';
              timeInp.style.fontSize="0.8rem"; timeInp.style.flex="0 0 100px";
              timeInp.placeholder = "HH:MM";
              timeInp.value = stop.time || "";
              timeInp.oninput = (e) => { stop.time = e.target.value; };
              timeInp.onclick = (e) => e.stopPropagation();

              botRow.append(dateInp, timeInp);

              item.append(topRow, botRow);

              // Drag Events
              item.addEventListener('dragstart', (e) => { dragSrcIndex = index; item.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
              item.addEventListener('dragend', () => { item.classList.remove('dragging'); document.querySelectorAll('.stop-item').forEach(el => el.classList.remove('drag-over')); });
              item.addEventListener('dragover', (e) => { e.preventDefault(); item.classList.add('drag-over'); return false; });
              item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
              item.addEventListener('drop', (e) => { e.stopPropagation(); if (dragSrcIndex !== index && dragSrcIndex > -1) { const moved = stops.splice(dragSrcIndex, 1)[0]; stops.splice(index, 0, moved); renderStops(); } return false; });

              listContainer.appendChild(item);
          });
      }

      const footer = document.createElement('div'); footer.className = 'editor-actions';
      const addBtn = document.createElement('button');
      addBtn.innerHTML = '<span class="material-icons-outlined" style="font-size:16px;">add</span> Add Stop';
      addBtn.onclick = (e) => { e.stopPropagation(); stops.push({ address: "", completed: false, type: 'DROP', date:"", time:"" }); renderStops(); setTimeout(() => listContainer.scrollTop = listContainer.scrollHeight, 50); };

      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn-primary'; saveBtn.innerText = 'Update Board';
      saveBtn.onclick = (e) => { e.stopPropagation(); closeEditor(true); };

      footer.append(addBtn, saveBtn);
      editor.append(listContainer, footer);
      document.body.appendChild(editor);

      // --- POSITIONING (FIXED to Prevent Overflow) ---
      const rect = anchorTd.getBoundingClientRect();
      const editorHeight = 400; // Approx max height
      const editorWidth = 480; 
      
      // Calculate Top: Try below first, if no space, go above
      let topPos = rect.bottom + 5;
      if (topPos + editorHeight > window.innerHeight) {
          topPos = rect.top - editorHeight - 5;
      }
      // Safety clamp for top
      if (topPos < 10) topPos = 10;
      if (topPos + editorHeight > window.innerHeight) topPos = window.innerHeight - editorHeight - 10;

      // Calculate Left: Try aligning left edge, then right edge
      let leftPos = rect.left;
      if (leftPos + editorWidth > window.innerWidth) {
          leftPos = window.innerWidth - editorWidth - 10;
      }
      if (leftPos < 10) leftPos = 10;

      editor.style.top = topPos + 'px';
      editor.style.left = leftPos + 'px';

      renderStops();

      setTimeout(() => {
          function handleClickOutside(e) {
              if (!editor.contains(e.target) && !anchorTd.contains(e.target)) { closeEditor(false); }
          }
          document.addEventListener('click', handleClickOutside);
          editor.dataset.cleanup = () => document.removeEventListener('click', handleClickOutside);
      }, 100);

      function closeEditor(shouldSave) {
          if(editor.dataset.cleanup) { /* cleanup */ }
          editor.remove();
          isEditing = false; editingId = null;

          if (shouldSave) {
              const cleanStops = stops.filter(s => s.address && s.address.trim() !== "");
              let payload = "";
              if (cleanStops.length > 0) payload = JSON.stringify(cleanStops);
              if (payload === rawVal) return;
              
              // Save JSON to Location Cell. Backend will parse this and update Time/Date columns automatically
              saveValue(rowId, locColIndex, payload, finalSaveTd, rawVal);
          }
      }
  }

  function deleteItem(id) { showConfirm("Delete", "Delete this row?", () => { google.script.run.withSuccessHandler(reloadData).deleteRow(id); }); }
  function showConfirm(t, tx, cb, showInput=false) { document.getElementById('modalTitle').innerText=t; document.getElementById('modalText').innerText=tx; const input = document.getElementById('modalInput'); input.style.display = showInput ? 'block' : 'none'; input.value = ''; modalCallback = cb; document.getElementById('genericModal').classList.add('active'); if(showInput) setTimeout(()=>input.focus(), 100); }
  function closeGenericModal() { document.getElementById('genericModal').classList.remove('active'); modalCallback=null; }
  document.getElementById('modalConfirmBtn').onclick = () => { const val=document.getElementById('modalInput').value; if(modalCallback) modalCallback(val); closeGenericModal(); };

  let modalCallback = null;
  function openHeaderMenu(e, i) { 
      e.stopPropagation(); currentMenuCol=i; const list=document.getElementById('filterList'); list.innerHTML='';
      const unique = [...new Set(tableData.rows.map(r=>String(r[i])))].sort();
      unique.forEach(v => { const chk = (colFilters[i]||[]).includes(v) || !colFilters[i]; list.innerHTML += `<label style="display:flex; align-items:center; padding:4px; gap:8px; cursor:pointer;"><input type="checkbox" value="${v}" ${chk?'checked':''}> <span style="font-size:0.8rem;">${v===""?"(Empty)":v}</span></label>`; });
      const menu = document.getElementById('headerMenu'); menu.style.display = 'flex'; 
      const rect = e.currentTarget.getBoundingClientRect(); let leftPos = rect.left; if (leftPos + 260 > window.innerWidth) leftPos = window.innerWidth - 280;
      menu.style.left = leftPos + 'px'; menu.style.top = (rect.bottom + 4) + 'px'; menu.classList.add('active'); 
  }
  function closeHeaderMenu() { const menu = document.getElementById('headerMenu'); menu.classList.remove('active'); menu.style.display = 'none'; }
  function toggleAllFilters(check) { const inputs = document.querySelectorAll('#filterList input[type="checkbox"]'); inputs.forEach(input => { if(input.closest('label').style.display !== 'none') input.checked = check; }); }
  function filterCheckboxes() { const v = document.getElementById('filterSearch').value.toLowerCase(); document.querySelectorAll('#filterList label').forEach(lbl => { lbl.style.display = lbl.innerText.toLowerCase().includes(v) ? 'flex' : 'none'; }); }
  function applyHeaderFilter() { const boxes = document.querySelectorAll('#filterList input:not(:checked)'); if(boxes.length===0) delete colFilters[currentMenuCol]; else { const checked = Array.from(document.querySelectorAll('#filterList input:checked')).map(c=>c.value); colFilters[currentMenuCol] = checked; } applyFilters(); closeHeaderMenu(); autoUpdateCurrentView(); }
  function applyFilters() { viewRows = tableData.rows.filter(r => { return Object.keys(colFilters).every(cIdx => colFilters[cIdx].includes(String(r[cIdx]))); }); render(); }
  function toggleViewsMenu() { document.getElementById('viewsMenu').classList.toggle('show'); }
  function handleCommand() { const v = document.getElementById('commandInput').value.toLowerCase(); viewRows = tableData.rows.filter(r => r.join(' ').toLowerCase().includes(v)); render(); }
    
  function refreshSavedViewsList() { google.script.run.withSuccessHandler(views => { const list = document.getElementById('savedViewsList'); list.innerHTML=''; if(!views || views.length === 0) { list.innerHTML = '<div style="padding:8px; font-size:0.8rem; color:#94a3b8; font-style:italic;">No saved views</div>'; } else { views.forEach(n => { const div = document.createElement('div'); div.className = 'menu-item'; const span = document.createElement('span'); span.innerHTML = `${n} ${n===currentPreset?'<i class="material-icons-outlined" style="font-size:14px; color:var(--primary);">check</i>':''}`; span.style.flex = "1"; span.onclick = () => loadPreset(n); const delBtn = document.createElement('i'); delBtn.className = 'material-icons-outlined del-view-btn'; delBtn.style.fontSize = "16px"; delBtn.innerText = "delete"; delBtn.title = "Delete View"; delBtn.onclick = (e) => { e.stopPropagation(); deletePreset(n); }; div.appendChild(span); div.appendChild(delBtn); list.appendChild(div); }); } }).getSavedViewsList(); }
  function deletePreset(n) { showConfirm("Delete View", `Are you sure you want to delete the view "${n}"?`, () => { google.script.run.withSuccessHandler((m) => { showToast(m, 'info'); if (currentPreset === n) resetView(); else refreshSavedViewsList(); }).deleteViewConfig(n); }); }
  
  function loadPreset(n) { 
      google.script.run.withSuccessHandler(c => { 
          if(c) { 
              currentPreset = n; 
              hiddenCols=c.hiddenCols||[]; 
              colFilters=c.colFilters||{}; 
              if (c.columnOrder) columnOrder = c.columnOrder; 
              if (c.customRowOrder) customRowOrder = c.customRowOrder; 
              if (c.columnWidths) columnWidths = c.columnWidths;
              if (c.columnAlignments) columnAlignments = c.columnAlignments;
              applyFilters(); refreshSavedViewsList(); showToast("View Loaded: " + n, 'success'); 
          } 
      }).loadViewConfig(n); 
  }
  
  function openSaveViewModal() { showConfirm("Save View", "Enter a name for this view:", (name) => { 
      if(name && name.trim() !== "") { 
          currentPreset = name; 
          const config = { 
              hiddenCols: hiddenCols, 
              colFilters: colFilters, 
              columnOrder: columnOrder, 
              customRowOrder: customRowOrder,
              columnWidths: columnWidths,
              columnAlignments: columnAlignments
          }; 
          google.script.run.withSuccessHandler(() => { showToast("View Saved", 'success'); refreshSavedViewsList(); }).saveViewConfig(name, config); 
      } 
  }, true); }
  
  function autoUpdateCurrentView() { 
      if (currentPreset) { 
          const config = { 
              hiddenCols: hiddenCols, 
              colFilters: colFilters, 
              columnOrder: columnOrder, 
              customRowOrder: customRowOrder,
              columnWidths: columnWidths,
              columnAlignments: columnAlignments
          }; 
          google.script.run.saveViewConfig(currentPreset, config); 
          const s = document.getElementById('saveStatus'); s.innerText = "View Updated"; s.classList.add('show'); 
          setTimeout(() => { s.innerText="Saved"; s.classList.remove('show'); }, 2000); 
      } 
  }
  
  function resetView() { 
      currentPreset = null; hiddenCols = [0]; colFilters = {}; 
      columnOrder = tableData.headers.map((_, i) => i); 
      customRowOrder = []; columnWidths = {}; columnAlignments = {};
      applyFilters(); refreshSavedViewsList(); showToast("Reset to Default", 'info'); 
  }
  function openColumnManager() { let h=''; tableData.headers.forEach((hd,i)=> h+=`<label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-idx="${i}" ${!hiddenCols.includes(i)?'checked':''}> ${hd}</label>`); document.getElementById('colList').innerHTML=h; document.getElementById('colModalOverlay').classList.add('active'); }
  function closeColumnManager() { document.getElementById('colModalOverlay').classList.remove('active'); }
  function saveColumnVisibility() { hiddenCols=[]; document.querySelectorAll('#colList input:not(:checked)').forEach(i=>hiddenCols.push(+i.dataset.idx)); render(); closeColumnManager(); autoUpdateCurrentView(); }
  function toggleAllColumns(c) { document.querySelectorAll('#colList input').forEach(i=>i.checked=c); }
  function showStatus(s) { isSaving=s; document.getElementById('saveStatus').classList.toggle('show', s); }

  function addNewRow() {
    const blankRow = new Array(tableData.headers.length - 1).fill(""); 
    
    showStatus(true);
    google.script.run.withSuccessHandler((res) => {
        showStatus(false);
        if(res === "Success") {
            showToast("New row added", "success");
            silentSync(); 
        } else {
            showToast("Failed to add row", "error");
        }
    }).withFailureHandler(err => {
        showStatus(false);
        showToast("Error adding row: " + err.message, "error");
    }).addRow(blankRow);
  }
  
// --- LOAD PARSER LOGIC ---
  let loadModalRowId = null;
  let loadModalColIndex = null;

  function openLoadModal(rowId, colIdx) {
      loadModalRowId = rowId; 
      loadModalColIndex = colIdx;
      
      const row = tableData.rows.find(r => String(r[0]) === String(rowId));
      const currentVal = row ? row[colIdx] : "";
      
      const modal = document.getElementById('loadParserModal');
      const input = document.getElementById('manualLoadInput');
      const area = document.getElementById('loadPasteArea');
      
      input.value = currentVal;
      area.value = "";
      modal.classList.add('active');
      
      setTimeout(() => area.focus(), 50);
      
      document.onkeydown = (e) => { if(e.key === "Escape") closeLoadModal(); };
  }

  function closeLoadModal() {
      document.getElementById('loadParserModal').classList.remove('active');
      loadModalRowId = null;
      document.onkeydown = null;
  }

  function saveManualLoad() {
      if(!loadModalRowId) return;
      const val = document.getElementById('manualLoadInput').value;
      const td = document.querySelector(`tr[data-id="${loadModalRowId}"] td:nth-child(${columnOrder.indexOf(loadModalColIndex)+1})`);
      
      const row = tableData.rows.find(r => String(r[0]) === String(loadModalRowId));
      if(row) row[loadModalColIndex] = val;
      if(td) td.innerText = val;

      google.script.run.updateSingleCell(loadModalRowId, loadModalColIndex, val);
      closeLoadModal();
  }

  function processPastedLoad() {
      const rawText = document.getElementById('loadPasteArea').value;
      if (!rawText.trim()) return;
      
      const targetId = loadModalRowId; 
      if(!targetId) { showToast("Error: No Row Selected", "error"); return; }

      showStatus(true);
      closeLoadModal();
      showToast("Analysing load text...", "info");

      google.script.run
        .withSuccessHandler((res) => {
            showStatus(false);
            if(res.error) {
                showToast(res.error, "error");
            } else {
                const r = tableData.rows.find(row => String(row[0]) === String(targetId));
                if(r) {
                    if(res.loadNumber) {
                        const loadColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("load #") || h.toLowerCase() === "load");
                        if(loadColIdx > -1) {
                            r[loadColIdx] = res.loadNumber;
                            const visualIdx = columnOrder.indexOf(loadColIdx);
                            const cell = document.querySelector(`tr[data-id="${targetId}"] td:nth-child(${visualIdx+1})`);
                            if(cell) { cell.innerHTML = res.loadNumber; highlightCell(cell); }
                        }
                    }

                    if(res.stops) {
                        const stopsColIdx = tableData.headers.findIndex(h => h.toLowerCase().includes("next appt location"));
                        if(stopsColIdx > -1) {
                            r[stopsColIdx] = res.stops;
                            const visualIdx = columnOrder.indexOf(stopsColIdx);
                            const cell = document.querySelector(`tr[data-id="${targetId}"] td:nth-child(${visualIdx+1})`);
                            if(cell) { 
                                cell.innerHTML = getCellDisplayHTML(r, stopsColIdx); 
                                highlightCell(cell); 
                            }
                        }
                    }
                    
                    if (res.calc) {
                        Object.keys(res.calc).forEach(cIdx => {
                            r[cIdx] = res.calc[cIdx];
                            const vIdx = columnOrder.indexOf(parseInt(cIdx));
                            const c = document.querySelector(`tr[data-id="${targetId}"] td:nth-child(${vIdx+1})`);
                            if(c) { c.innerHTML = getCellDisplayHTML(r, parseInt(cIdx)); highlightCell(c); }
                        });
                    }
                }
                showToast("Load details saved!", "success");
            }
        })
        .withFailureHandler(e => { 
            showStatus(false); 
            showToast("Parser failed: " + e.message, "error"); 
        })
        .parseAndSaveLoadDetails(targetId, rawText);
  }
// --- UTILS FOR MAP SNAPPING (MATH ENGINE) ---
const RouteUtils = {
    distance: (a, b) => {
        // Haversine formula for distance between two points [lon, lat]
        const R = 6371e3; // Earth radius in meters
        const 1 = a[1] * Math.PI/180;
        const 2 = b[1] * Math.PI/180;
        const  = (b[1]-a[1]) * Math.PI/180;
        const  = (b[0]-a[0]) * Math.PI/180;
        const x = Math.sin(/2) * Math.sin(/2) + Math.cos(1) * Math.cos(2) * Math.sin(/2) * Math.sin(/2);
        const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
        return R * c;
    },
    getCoordAtDist: (coords, dist) => {
        // Returns the [lon, lat] at exactly 'dist' meters along the line
        let covered = 0;
        for(let i=0; i<coords.length-1; i++){
            const d = RouteUtils.distance(coords[i], coords[i+1]);
            if(covered + d >= dist) {
                const ratio = (dist - covered) / d;
                const lng = coords[i][0] + (coords[i+1][0] - coords[i][0]) * ratio;
                const lat = coords[i][1] + (coords[i+1][1] - coords[i][1]) * ratio;
                return [lng, lat];
            }
            covered += d;
        }
        return coords[coords.length-1]; // End of line
    },
    snapToLine: (pt, line) => {
        // Finds closest point on line and how far along the route it is
        let minDist = Infinity;
        let closestDistAlong = 0;
        let runningDist = 0;
        
        for(let i=0; i<line.length-1; i++){
            const start = line[i];
            const end = line[i+1];
            const segLen = RouteUtils.distance(start, end);
            
            // Simple distance check to start point (good enough for GPS snapping)
            const dPt = RouteUtils.distance(pt, start);
            
            if(dPt < minDist) { 
                minDist = dPt; 
                closestDistAlong = runningDist; 
            }
            runningDist += segLen;
        }
        return { travelDistance: closestDistAlong };
    }
};
</script>
</body>
</html>
